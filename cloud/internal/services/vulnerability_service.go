package services

import (
	"context"
	"encoding/json"
	"time"

	"cloud-system/internal/models"
	"cloud-system/internal/repository"
	"cloud-system/pkg/errors"

	"go.uber.org/zap"
)

// VulnerabilityService 脆弱性评估服务接口
type VulnerabilityService interface {
	// SyncAssessment 接收Edge端同步的评估数据
	SyncAssessment(ctx context.Context, req *models.VulnerabilitySyncRequest) error

	// GetLatestAssessment 获取储能柜最新评估
	GetLatestAssessment(ctx context.Context, cabinetID string) (*models.VulnerabilityDetailResponse, error)

	// ListAssessments 分页查询评估记录
	ListAssessments(ctx context.Context, query *models.VulnerabilityListQuery) (*models.VulnerabilityListResponse, error)

	// GetAssessmentDetail 获取评估详情
	GetAssessmentDetail(ctx context.Context, assessmentID int64) (*models.VulnerabilityDetailResponse, error)

	// GetHistory 获取历史评估
	GetHistory(ctx context.Context, cabinetID string, startTime, endTime time.Time, limit int) ([]*models.VulnerabilityAssessment, error)

	// GetStats 获取评估统计
	GetStats(ctx context.Context, cabinetID string, days int) (map[string]interface{}, error)
}

// vulnerabilityService 脆弱性评估服务实现
type vulnerabilityService struct {
	repo        repository.VulnerabilityRepository
	cabinetRepo repository.CabinetRepository // 新增：用于更新储能柜缓存
	logger      *zap.Logger
}

// NewVulnerabilityService 创建服务实例
func NewVulnerabilityService(repo repository.VulnerabilityRepository, cabinetRepo repository.CabinetRepository, logger *zap.Logger) VulnerabilityService {
	return &vulnerabilityService{
		repo:        repo,
		cabinetRepo: cabinetRepo,
		logger:      logger,
	}
}

// SyncAssessment 接收Edge端同步的评估数据
func (s *vulnerabilityService) SyncAssessment(ctx context.Context, req *models.VulnerabilitySyncRequest) error {
	s.logger.Info("接收脆弱性评估同步",
		zap.String("cabinet_id", req.CabinetID),
		zap.Float64("overall_score", req.OverallScore),
		zap.String("risk_level", req.RiskLevel),
	)

	// 1. 序列化JSON字段
	transmissionMetrics := toJSONString(req.TransmissionMetrics)
	trafficFeatures := toJSONString(req.TrafficFeatures)
	configChecks := toJSONString(req.ConfigChecks)
	detectedVulnerabilities := toJSONString(req.DetectedVulnerabilities)

	// 2. 创建评估记录
	assessment := &models.VulnerabilityAssessment{
		CabinetID:               req.CabinetID,
		Timestamp:               req.Timestamp,
		LicenseComplianceScore:  req.LicenseComplianceScore,
		CommunicationScore:      req.CommunicationScore,
		ConfigSecurityScore:     req.ConfigSecurityScore,
		DataAnomalyScore:        req.DataAnomalyScore,
		OverallScore:            req.OverallScore,
		RiskLevel:               req.RiskLevel,
		TransmissionMetrics:     transmissionMetrics,
		TrafficFeatures:         trafficFeatures,
		ConfigChecks:            configChecks,
		DetectedVulnerabilities: detectedVulnerabilities,
		SyncedFromEdge:          true,
		ReceivedAt:              time.Now(),
	}

	assessmentID, err := s.repo.CreateAssessment(ctx, assessment)
	if err != nil {
		s.logger.Error("创建评估记录失败", zap.Error(err))
		return errors.Wrap(err, errors.ErrInternalServer, "创建评估记录失败")
	}

	// 3. 创建漏洞事件记录
	if len(req.DetectedVulnerabilities) > 0 {
		events := make([]*models.VulnerabilityEvent, 0, len(req.DetectedVulnerabilities))
		for _, dto := range req.DetectedVulnerabilities {
			event := &models.VulnerabilityEvent{
				AssessmentID: assessmentID,
				CabinetID:    req.CabinetID,
				EventType:    dto.Type,
				Category:     dto.Category,
				Title:        dto.Title,
				Severity:     dto.Severity,
				Description:  dto.Description,
				Solution:     &dto.Solution,
				DetectedAt:   dto.DetectedAt,
			}
			events = append(events, event)
		}

		if err := s.repo.CreateEvents(ctx, events); err != nil {
			s.logger.Error("创建漏洞事件失败", zap.Error(err))
			// 不返回错误,因为评估记录已经创建成功
		}
	}

	// 4. 更新储能柜的脆弱性评分缓存
	if err := s.cabinetRepo.UpdateVulnerabilityScore(ctx, req.CabinetID, req.OverallScore, req.RiskLevel); err != nil {
		s.logger.Warn("更新储能柜脆弱性评分缓存失败",
			zap.String("cabinet_id", req.CabinetID),
			zap.Error(err),
		)
		// 不返回错误,因为评估记录已经创建成功
	}

	s.logger.Info("脆弱性评估同步成功",
		zap.Int64("assessment_id", assessmentID),
		zap.Int("events_count", len(req.DetectedVulnerabilities)),
	)

	return nil
}

// GetLatestAssessment 获取储能柜最新评估
func (s *vulnerabilityService) GetLatestAssessment(ctx context.Context, cabinetID string) (*models.VulnerabilityDetailResponse, error) {
	assessment, err := s.repo.GetLatestByCabinetID(ctx, cabinetID)
	if err != nil {
		s.logger.Error("获取最新评估失败", zap.Error(err))
		return nil, errors.Wrap(err, errors.ErrInternalServer, "获取评估失败")
	}

	if assessment == nil {
		return nil, errors.New(errors.ErrNotFound, "未找到评估数据")
	}

	// 获取漏洞事件
	events, err := s.repo.GetEventsByAssessmentID(ctx, assessment.ID)
	if err != nil {
		s.logger.Error("获取漏洞事件失败", zap.Error(err))
		events = []*models.VulnerabilityEvent{} // 即使失败也返回空数组
	}

	return &models.VulnerabilityDetailResponse{
		Assessment: assessment,
		Events:     events,
	}, nil
}

// ListAssessments 分页查询评估记录
func (s *vulnerabilityService) ListAssessments(ctx context.Context, query *models.VulnerabilityListQuery) (*models.VulnerabilityListResponse, error) {
	assessments, total, err := s.repo.ListAssessments(ctx, query)
	if err != nil {
		s.logger.Error("查询评估列表失败", zap.Error(err))
		return nil, errors.Wrap(err, errors.ErrInternalServer, "查询失败")
	}

	// 计算总页数
	totalPages := int(total) / query.PageSize
	if int(total)%query.PageSize > 0 {
		totalPages++
	}

	return &models.VulnerabilityListResponse{
		Items:      assessments,
		Total:      total,
		Page:       query.Page,
		PageSize:   query.PageSize,
		TotalPages: totalPages,
	}, nil
}

// GetAssessmentDetail 获取评估详情
func (s *vulnerabilityService) GetAssessmentDetail(ctx context.Context, assessmentID int64) (*models.VulnerabilityDetailResponse, error) {
	assessment, err := s.repo.GetAssessmentByID(ctx, assessmentID)
	if err != nil {
		s.logger.Error("获取评估详情失败", zap.Error(err))
		return nil, errors.Wrap(err, errors.ErrInternalServer, "获取评估失败")
	}

	if assessment == nil {
		return nil, errors.New(errors.ErrNotFound, "评估不存在")
	}

	// 获取漏洞事件
	events, err := s.repo.GetEventsByAssessmentID(ctx, assessmentID)
	if err != nil {
		s.logger.Error("获取漏洞事件失败", zap.Error(err))
		events = []*models.VulnerabilityEvent{}
	}

	return &models.VulnerabilityDetailResponse{
		Assessment: assessment,
		Events:     events,
	}, nil
}

// GetHistory 获取历史评估
func (s *vulnerabilityService) GetHistory(ctx context.Context, cabinetID string, startTime, endTime time.Time, limit int) ([]*models.VulnerabilityAssessment, error) {
	assessments, err := s.repo.GetHistoryByCabinetID(ctx, cabinetID, startTime, endTime, limit)
	if err != nil {
		s.logger.Error("获取历史评估失败", zap.Error(err))
		return nil, errors.Wrap(err, errors.ErrInternalServer, "查询失败")
	}

	return assessments, nil
}

// GetStats 获取评估统计
func (s *vulnerabilityService) GetStats(ctx context.Context, cabinetID string, days int) (map[string]interface{}, error) {
	if days <= 0 {
		days = 30 // 默认30天
	}

	stats, err := s.repo.GetStatsByCabinetID(ctx, cabinetID, days)
	if err != nil {
		s.logger.Error("获取统计数据失败", zap.Error(err))
		return nil, errors.Wrap(err, errors.ErrInternalServer, "查询失败")
	}

	return stats, nil
}

// toJSONString 将对象转换为JSON字符串
func toJSONString(data interface{}) *string {
	if data == nil {
		return nil
	}
	bytes, err := json.Marshal(data)
	if err != nil {
		return nil
	}
	str := string(bytes)
	return &str
}
