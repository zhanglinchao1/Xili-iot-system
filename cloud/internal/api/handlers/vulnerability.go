package handlers

import (
	"net/http"
	"strconv"
	"time"

	"cloud-system/internal/models"
	"cloud-system/internal/services"
	"cloud-system/internal/utils"
	"cloud-system/pkg/errors"

	"github.com/gin-gonic/gin"
)

// VulnerabilityHandler 脆弱性评估处理器
type VulnerabilityHandler struct {
	vulnService services.VulnerabilityService
}

// NewVulnerabilityHandler 创建处理器实例
func NewVulnerabilityHandler(vulnService services.VulnerabilityService) *VulnerabilityHandler {
	return &VulnerabilityHandler{
		vulnService: vulnService,
	}
}

// SyncAssessment 接收Edge端同步的评估数据
// @Summary 同步脆弱性评估
// @Tags Vulnerability
// @Accept json
// @Produce json
// @Param cabinet_id path string true "储能柜ID"
// @Param request body models.VulnerabilitySyncRequest true "评估数据"
// @Success 200 {object} utils.SuccessResponse
// @Failure 400 {object} errors.ErrorResponse
// @Router /api/v1/cabinets/{cabinet_id}/vulnerability/sync [post]
func (h *VulnerabilityHandler) SyncAssessment(c *gin.Context) {
	cabinetID := c.Param("cabinet_id")

	var request models.VulnerabilitySyncRequest
	if err := c.ShouldBindJSON(&request); err != nil {
		utils.ValidationError(c, "请求参数格式错误")
		return
	}

	// 确保请求中的cabinet_id与路径参数一致
	request.CabinetID = cabinetID

	// 如果timestamp为空,使用当前时间
	if request.Timestamp.IsZero() {
		request.Timestamp = time.Now()
	}

	err := h.vulnService.SyncAssessment(c.Request.Context(), &request)
	if err != nil {
		appErr := err.(*errors.AppError)
		statusCode := http.StatusInternalServerError
		if appErr.Code == errors.ErrBadRequest {
			statusCode = http.StatusBadRequest
		}
		utils.ErrorResponse(c, statusCode, appErr)
		return
	}

	utils.SuccessWithMessage(c, nil, "评估数据同步成功")
}

// GetLatestAssessment 获取储能柜最新评估
// @Summary 获取最新脆弱性评估
// @Tags Vulnerability
// @Accept json
// @Produce json
// @Param cabinet_id path string true "储能柜ID"
// @Success 200 {object} utils.SuccessResponse{data=models.VulnerabilityDetailResponse}
// @Failure 404 {object} errors.ErrorResponse
// @Router /api/v1/cabinets/{cabinet_id}/vulnerability/latest [get]
func (h *VulnerabilityHandler) GetLatestAssessment(c *gin.Context) {
	cabinetID := c.Param("cabinet_id")

	detail, err := h.vulnService.GetLatestAssessment(c.Request.Context(), cabinetID)
	if err != nil {
		appErr := err.(*errors.AppError)
		statusCode := http.StatusInternalServerError
		if appErr.Code == errors.ErrNotFound {
			statusCode = http.StatusNotFound
		}
		utils.ErrorResponse(c, statusCode, appErr)
		return
	}

	utils.Success(c, detail)
}

// ListAssessments 分页查询评估记录
// @Summary 查询评估列表
// @Tags Vulnerability
// @Accept json
// @Produce json
// @Param cabinet_id query string false "储能柜ID"
// @Param start_time query string false "开始时间"
// @Param end_time query string false "结束时间"
// @Param risk_level query string false "风险等级"
// @Param page query int false "页码"
// @Param page_size query int false "每页数量"
// @Success 200 {object} utils.SuccessResponse{data=models.VulnerabilityListResponse}
// @Failure 400 {object} errors.ErrorResponse
// @Router /api/v1/vulnerability/assessments [get]
func (h *VulnerabilityHandler) ListAssessments(c *gin.Context) {
	var query models.VulnerabilityListQuery

	// 绑定查询参数
	if err := c.ShouldBindQuery(&query); err != nil {
		utils.ValidationError(c, "查询参数格式错误")
		return
	}

	// 设置默认分页参数
	if query.Page <= 0 {
		query.Page = 1
	}
	if query.PageSize <= 0 {
		query.PageSize = 20
	}
	if query.PageSize > 100 {
		query.PageSize = 100 // 限制最大页面大小
	}

	response, err := h.vulnService.ListAssessments(c.Request.Context(), &query)
	if err != nil {
		appErr := err.(*errors.AppError)
		utils.ErrorResponse(c, http.StatusInternalServerError, appErr)
		return
	}

	utils.Success(c, response)
}

// GetAssessmentDetail 获取评估详情
// @Summary 获取评估详情
// @Tags Vulnerability
// @Accept json
// @Produce json
// @Param id path int true "评估ID"
// @Success 200 {object} utils.SuccessResponse{data=models.VulnerabilityDetailResponse}
// @Failure 404 {object} errors.ErrorResponse
// @Router /api/v1/vulnerability/assessments/{id} [get]
func (h *VulnerabilityHandler) GetAssessmentDetail(c *gin.Context) {
	idStr := c.Param("id")
	id, err := strconv.ParseInt(idStr, 10, 64)
	if err != nil {
		utils.ValidationError(c, "无效的评估ID")
		return
	}

	detail, err := h.vulnService.GetAssessmentDetail(c.Request.Context(), id)
	if err != nil {
		appErr := err.(*errors.AppError)
		statusCode := http.StatusInternalServerError
		if appErr.Code == errors.ErrNotFound {
			statusCode = http.StatusNotFound
		}
		utils.ErrorResponse(c, statusCode, appErr)
		return
	}

	utils.Success(c, detail)
}

// GetHistory 获取历史评估
// @Summary 获取历史评估
// @Tags Vulnerability
// @Accept json
// @Produce json
// @Param cabinet_id path string true "储能柜ID"
// @Param start_time query string false "开始时间"
// @Param end_time query string false "结束时间"
// @Param limit query int false "限制数量"
// @Success 200 {object} utils.SuccessResponse{data=[]models.VulnerabilityAssessment}
// @Failure 400 {object} errors.ErrorResponse
// @Router /api/v1/cabinets/{cabinet_id}/vulnerability/history [get]
func (h *VulnerabilityHandler) GetHistory(c *gin.Context) {
	cabinetID := c.Param("cabinet_id")

	// 解析时间参数
	startTimeStr := c.DefaultQuery("start_time", "")
	endTimeStr := c.DefaultQuery("end_time", "")
	limitStr := c.DefaultQuery("limit", "100")

	var startTime, endTime time.Time
	var err error

	if startTimeStr != "" {
		startTime, err = time.Parse(time.RFC3339, startTimeStr)
		if err != nil {
			utils.ValidationError(c, "start_time格式错误,应为RFC3339格式")
			return
		}
	} else {
		// 默认7天前
		startTime = time.Now().AddDate(0, 0, -7)
	}

	if endTimeStr != "" {
		endTime, err = time.Parse(time.RFC3339, endTimeStr)
		if err != nil {
			utils.ValidationError(c, "end_time格式错误,应为RFC3339格式")
			return
		}
	} else {
		// 默认当前时间
		endTime = time.Now()
	}

	limit, err := strconv.Atoi(limitStr)
	if err != nil || limit <= 0 {
		limit = 100
	}
	if limit > 1000 {
		limit = 1000 // 限制最大数量
	}

	assessments, err := h.vulnService.GetHistory(c.Request.Context(), cabinetID, startTime, endTime, limit)
	if err != nil {
		appErr := err.(*errors.AppError)
		utils.ErrorResponse(c, http.StatusInternalServerError, appErr)
		return
	}

	utils.Success(c, assessments)
}

// GetStats 获取评估统计
// @Summary 获取评估统计
// @Tags Vulnerability
// @Accept json
// @Produce json
// @Param cabinet_id path string true "储能柜ID"
// @Param days query int false "统计天数"
// @Success 200 {object} utils.SuccessResponse{data=map[string]interface{}}
// @Failure 400 {object} errors.ErrorResponse
// @Router /api/v1/cabinets/{cabinet_id}/vulnerability/stats [get]
func (h *VulnerabilityHandler) GetStats(c *gin.Context) {
	cabinetID := c.Param("cabinet_id")

	daysStr := c.DefaultQuery("days", "30")
	days, err := strconv.Atoi(daysStr)
	if err != nil || days <= 0 {
		days = 30
	}
	if days > 90 {
		days = 90 // 限制最大90天
	}

	stats, err := h.vulnService.GetStats(c.Request.Context(), cabinetID, days)
	if err != nil {
		appErr := err.(*errors.AppError)
		utils.ErrorResponse(c, http.StatusInternalServerError, appErr)
		return
	}

	utils.Success(c, stats)
}
