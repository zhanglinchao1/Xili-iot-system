-- 012_replace_health_score_with_vulnerability.sql
-- 用脆弱性评分替代健康评分,精简评分体系

-- 1. 添加新字段: 缓存最新的脆弱性评分
ALTER TABLE cabinets
    ADD COLUMN IF NOT EXISTS latest_vulnerability_score FLOAT DEFAULT 0;

ALTER TABLE cabinets
    ADD COLUMN IF NOT EXISTS latest_risk_level TEXT DEFAULT 'unknown';

ALTER TABLE cabinets
    ADD COLUMN IF NOT EXISTS vulnerability_updated_at TIMESTAMP;

-- 2. 从现有vulnerability_assessments表同步最新评分到cabinets表(初始化数据)
-- 使用DISTINCT ON获取每个储能柜的最新评估记录
UPDATE cabinets c
SET
    latest_vulnerability_score = COALESCE(v.overall_score, 0),
    latest_risk_level = COALESCE(v.risk_level, 'unknown'),
    vulnerability_updated_at = v.timestamp
FROM (
    SELECT DISTINCT ON (cabinet_id)
        cabinet_id,
        overall_score,
        risk_level,
        timestamp
    FROM vulnerability_assessments
    ORDER BY cabinet_id, timestamp DESC
) v
WHERE c.cabinet_id = v.cabinet_id;

-- 3. 删除旧的health_score字段
-- 注意: 先备份数据后再删除
-- 如果需要回滚,可以从备份恢复
ALTER TABLE cabinets DROP COLUMN IF EXISTS health_score;

-- 5. 创建索引优化查询性能
CREATE INDEX IF NOT EXISTS idx_cabinets_vulnerability_score
    ON cabinets(latest_vulnerability_score DESC);

CREATE INDEX IF NOT EXISTS idx_cabinets_risk_level
    ON cabinets(latest_risk_level);
