# 宝塔面板 Nginx 配置模板
# 适用于 Cloud 端部署在云服务器的场景
# 使用方法：
# 1. 在宝塔面板创建网站（域名或使用服务器IP）
# 2. 在网站设置 → 配置文件中，将以下配置添加到 server 块内
# 3. 确保后端服务运行在 127.0.0.1:8003

# ============================================
# 方案A：前端 + 后端都通过 Nginx 代理（推荐）
# 前端访问：http://150.158.102.52/
# 后端API：http://150.158.102.52/api/v1
# ============================================

server {
    listen 80;
    server_name 150.158.102.52;  # 替换为你的域名或IP
    
    # 前端静态文件目录（上传 Cloud/frontend/dist/ 的内容到此目录）
    root /www/wwwroot/cloud-frontend;
    index index.html;
    
    # 启用gzip压缩
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css text/xml text/javascript application/x-javascript application/xml+rss application/json application/javascript;
    
    # 后端API代理
    location /api/ {
        proxy_pass http://127.0.0.1:8003;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        proxy_read_timeout 300s;
        proxy_connect_timeout 75s;
        
        # CORS 头（如果后端已设置，可以删除这些）
        add_header Access-Control-Allow-Origin *;
        add_header Access-Control-Allow-Methods 'GET, POST, PUT, DELETE, OPTIONS';
        add_header Access-Control-Allow-Headers 'Content-Type, Authorization, X-API-Key';
        
        if ($request_method = 'OPTIONS') {
            return 204;
        }
    }
    
    # 健康检查端点（转发到后端）
    location /health {
        proxy_pass http://127.0.0.1:8003/health;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        access_log off;
    }
    
    # WebSocket支持
    location /ws {
        proxy_pass http://127.0.0.1:8003/ws;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_read_timeout 3600s;
    }
    
    # 静态资源缓存
    location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
    
    # Vue Router History模式支持
    location / {
        try_files $uri $uri/ /index.html;
        add_header Cache-Control "no-cache";
    }
    
    # 错误页面
    error_page 404 /index.html;
}

# ============================================
# 方案B：只部署后端，直接暴露 8003 端口
# 后端API：http://150.158.102.52:8003/api/v1
# 需要在云服务商安全组开放 8003 端口
# ============================================

# 1. 确保后端 config.yaml 配置：
#    server:
#      host: 0.0.0.0  # 必须是 0.0.0.0
#      port: 8003
#
# 2. 启动后端服务：
#    cd /opt/Cloud
#    nohup ./cloud-server > /var/log/cloud-server.log 2>&1 &
#
# 3. 开放防火墙端口：
#    sudo ufw allow 8003
#
# 4. 在云服务商控制台添加安全组规则：
#    - 协议：TCP
#    - 端口：8003
#    - 来源：0.0.0.0/0
#
# 5. Edge端配置：
#    endpoint: http://150.158.102.52:8003/api/v1

# ============================================
# 诊断命令
# ============================================

# 1. 检查后端进程
#    ps aux | grep cloud-server

# 2. 检查端口监听（必须是 0.0.0.0，不能是 127.0.0.1）
#    ss -tlnp | grep 8003
#    输出应该包含：0.0.0.0:8003

# 3. 本地测试
#    curl http://localhost:8003/health
#    curl http://127.0.0.1:8003/health
#    curl http://0.0.0.0:8003/health

# 4. 外网测试（在Edge端或本地机器执行）
#    curl http://150.158.102.52:8003/health

# 5. 端口连通性测试
#    nc -zv 150.158.102.52 8003
#    telnet 150.158.102.52 8003

# 6. 查看 Nginx 错误日志
#    tail -f /www/wwwroot/cloud-frontend/logs/error.log
#    tail -f /www/server/nginx/logs/error.log

# 7. 查看后端日志
#    tail -f /var/log/cloud-server.log

