# Cloud端储能柜集群管理系统配置文件

# 服务器配置
server:
  port: 8003
  host: 0.0.0.0
  mode: release  # debug, release, test
  read_timeout: 30s
  write_timeout: 30s
  max_header_bytes: 1048576

# 数据库配置
database:
  postgres:
    host: localhost
    port: 5432
    user: cloud_user
    password: cloud123456
    dbname: cloud_system
    sslmode: disable
    max_connections: 100
    max_idle_connections: 10
    connection_max_lifetime: 3600s
  # 数据库迁移专用配置（可选，用于执行需要超级用户权限的迁移）
  # 如果未配置，将使用上面的postgres配置
  migration:
    user: postgres          # 迁移使用的数据库用户（建议使用postgres超级用户）
    password: postgres123   # 迁移用户的密码（已设置为postgres123）
    # 注意：如果使用sudo执行，可以设置use_sudo: true，这样不需要密码
    use_sudo: false         # 是否使用sudo执行（需要sudo权限，但不需要数据库密码）
  redis:
    host: localhost
    port: 6379
    password: ""
    db: 0
    pool_size: 10
    min_idle_conns: 5
    dial_timeout: 5s
    read_timeout: 3s
    write_timeout: 3s

# MQTT配置（用于Cloud端发布命令）
# 本地开发环境连接到本地MQTT broker
# Docker环境请使用 config.docker.yaml
mqtt:
  broker: ssl://localhost:8884  # 本地开发使用localhost
  username: ""
  password: ""
  client_id: cloud-server
  qos: 1
  clean_session: true
  keep_alive: 60
  reconnect_delay: 5s
  max_reconnect_interval: 300s
  # TLS配置（与Edge端共用证书）
  tls:
    enabled: true
    ca_file: /app/configs/certs/ca.crt
    insecure_skip_verify: true  # 临时跳过证书验证(本地开发)

# Edge端MQTT配置（订阅Edge端传感器数据）
# Cloud端通过MQTT桥接接收Edge端数据，所以这里连接的是Cloud自己的MQTT broker
edge_mqtt:
  enabled: true  # 是否启用Edge端MQTT订阅
  broker: ssl://localhost:8884  # 本地开发使用localhost
  username: ""  # Edge端MQTT用户名（如果有）
  password: ""  # Edge端MQTT密码（如果有）
  client_id: cloud-edge-subscriber  # 客户端ID
  qos: 1  # QoS级别
  clean_session: true  # 是否清理会话
  keep_alive: 60  # 保持连接时间（秒）
  reconnect_delay: 5s  # 重连延迟
  max_reconnect_interval: 300s  # 最大重连间隔
  # TLS配置
  tls:
    enabled: true  # 启用TLS
    ca_file: /app/configs/certs/ca.crt  # CA证书路径（容器内路径）
    insecure_skip_verify: true  # 临时跳过证书验证(本地开发)

# Edge HTTP API（用于Cloud调用Edge执行动作）
edge_api:
  base_url: http://localhost:8001/api/v1
  scheme: http
  port: 8001
  timeout: 5s

# JWT认证配置
jwt:
  secret: cloud-system-jwt-secret-key-2025
  expiry: 720h  # 30天（1个月）
  refresh_expiry: 2160h  # 90天（3个月）

# 日志配置
logging:
  level: debug  # debug, info, warn, error
  format: json  # json, text
  output: stdout  # stdout, file, both
  file_path: logs/cloud-server.log
  max_size: 100  # MB
  max_backups: 5
  max_age: 30  # days
  compress: true

# 业务参数配置
business:
  # 健康评分算法权重（权重之和必须为1.0）
  health_score:
    weights:
      online_rate: 0.4      # 设备在线率权重
      data_quality: 0.3     # 数据质量权重
      alert_severity: 0.2   # 告警严重度权重
      sensor_normalcy: 0.1  # 传感器数值正常率权重
    update_interval: 5m     # 健康评分更新间隔
  
  # 告警配置
  alerts:
    offline_timeout: 300     # 设备离线超时时间（秒）
    severity_levels:
      info: 0
      warning: 1
      error: 2
      critical: 3
    retention_days: 90       # 告警保留天数
  
  # 数据同步配置
  sync:
    batch_size: 1000         # 每次同步最大数据量
    sync_interval: 5m         # Edge端同步间隔
    timeout: 30s             # 同步超时时间
  
  # 许可证配置
  license:
    cache_ttl: 3600s         # Redis缓存TTL（秒）
    validation_interval: 1h   # Edge端验证间隔
    offline_grace_period: 24h # 离线宽限期
  
  # 命令下发配置
  command:
    timeout: 30s             # 命令超时时间
    retry_count: 3           # 重试次数
    retry_delay: 5s          # 重试延迟
  
  # 前端配置（通过API暴露给前端）
  frontend:
    api_base_url: http://localhost:8003/api/v1
    polling_interval: 5000   # 前端轮询间隔（毫秒）
    chart_refresh_interval: 30000  # 图表刷新间隔（毫秒）
    page_size: 20            # 默认分页大小
    max_page_size: 100       # 最大分页大小
    
  # 地图配置
  map:
    enabled: true            # 是否启用地图功能
    provider: tencent        # 地图服务提供商：tencent, amap, baidu, leaflet
    tencent_map_key: "ONHBZ-K6ZCL-6UXPG-MY5O5-BVFAF-2TB5T"  # 腾讯地图API Key (用于前端和WebService API)
    default_center:
      latitude: 30.287459    # 默认中心点纬度（杭州市）
      longitude: 120.153576  # 默认中心点经度
    default_zoom: 11        # 默认缩放级别（11为市级视图，显示杭州市区范围）

# 监控配置
monitoring:
  enabled: true
  metrics_path: /metrics
  health_check_path: /health
  profiler_enabled: false
  profiler_path: /debug/pprof

# CORS配置（已禁用 - 前端通过nginx代理访问后端，不需要CORS）
cors:
  enabled: false

# ABAC访问控制配置
abac:
  enabled: true                  # 是否启用ABAC
  log_access: true               # 是否记录访问日志
  default_deny: false            # 默认拒绝(无匹配策略时)
  cache_policies: true           # 是否缓存策略(提升性能)
  cache_ttl: 300                 # 缓存过期时间(秒)
  trust_score_threshold: 30      # 最低信任度阈值
