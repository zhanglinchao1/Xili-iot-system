<template>
  <div class="vulnerability-detail-page">
    <!-- 面包屑导航 -->
    <el-breadcrumb separator="/" class="breadcrumb">
      <el-breadcrumb-item :to="{ path: '/vulnerability' }">脆弱性评价</el-breadcrumb-item>
      <el-breadcrumb-item>{{ cabinetId }}</el-breadcrumb-item>
    </el-breadcrumb>

    <!-- 页面头部 -->
    <div class="page-header">
      <div class="header-content">
        <h1 class="title">{{ cabinetId }} - 脆弱性详情</h1>
        <p class="subtitle">{{ cabinetInfo.location }}</p>
      </div>
      <div class="header-actions">
        <el-button :icon="Refresh" :loading="loading" @click="refreshData">刷新</el-button>
        <el-button type="primary" :icon="Download" :loading="exporting" @click="exportPDF">导出报告</el-button>
      </div>
    </div>

    <!-- 综合评分卡片 -->
    <el-card class="score-card">
      <div class="score-overview">
        <div class="overall-score">
          <div class="score-circle" :class="getScoreClass(assessment.overallScore)">
            <span class="score-value">{{ assessment.overallScore }}</span>
            <span class="score-suffix">分</span>
          </div>
          <div class="score-info">
            <h2>综合安全评分</h2>
            <el-tag :type="getRiskType(assessment.riskLevel)" size="large">
              {{ getRiskLabel(assessment.riskLevel) }}
            </el-tag>
            <p class="assessment-time">最后评估: {{ assessment.lastAssessment }}</p>
          </div>
        </div>

        <!-- 各维度评分 -->
        <div class="dimension-scores">
          <div class="dimension-item">
            <div class="dimension-header">
              <el-icon class="dimension-icon"><Key /></el-icon>
              <span class="dimension-name">许可证合规性</span>
              <span class="dimension-weight">30%</span>
            </div>
            <el-progress
              :percentage="assessment.licenseCompliance"
              :color="getProgressColor(assessment.licenseCompliance)"
              :stroke-width="12"
            />
            <p class="dimension-desc">{{ getLicenseStatus() }}</p>
          </div>

          <div class="dimension-item">
            <div class="dimension-header">
              <el-icon class="dimension-icon"><DataLine /></el-icon>
              <span class="dimension-name">数据异常检测</span>
              <span class="dimension-weight">25%</span>
            </div>
            <el-progress
              :percentage="assessment.dataAnomaly"
              :color="getProgressColor(assessment.dataAnomaly)"
              :stroke-width="12"
            />
            <p class="dimension-desc">{{ getDataAnomalyStatus() }}</p>
          </div>

          <div class="dimension-item">
            <div class="dimension-header">
              <el-icon class="dimension-icon"><Connection /></el-icon>
              <span class="dimension-name">通信异常</span>
              <span class="dimension-weight">25%</span>
            </div>
            <el-progress
              :percentage="assessment.communicationAnomaly"
              :color="getProgressColor(assessment.communicationAnomaly)"
              :stroke-width="12"
            />
            <p class="dimension-desc">{{ getCommunicationStatus() }}</p>
          </div>

          <div class="dimension-item">
            <div class="dimension-header">
              <el-icon class="dimension-icon"><Setting /></el-icon>
              <span class="dimension-name">配置安全性</span>
              <span class="dimension-weight">20%</span>
            </div>
            <el-progress
              :percentage="assessment.configSecurity"
              :color="getProgressColor(assessment.configSecurity)"
              :stroke-width="12"
            />
            <p class="dimension-desc">{{ getConfigSecurityStatus() }}</p>
          </div>
        </div>
      </div>
    </el-card>

    <!-- 安全风险列表 -->
    <el-card class="risks-card" v-if="securityRisks.length > 0">
      <template #header>
        <div class="card-header">
          <span class="card-title">
            <el-icon><Warning /></el-icon>
            发现的安全风险
          </span>
          <el-tag type="danger">{{ securityRisks.length }} 个风险</el-tag>
        </div>
      </template>

      <div class="risks-list">
        <div
          v-for="risk in securityRisks"
          :key="risk.id"
          class="risk-item"
          :class="`risk-${risk.severity}`"
        >
          <div class="risk-header">
            <el-icon class="risk-icon" :class="`severity-${risk.severity}`">
              <WarningFilled v-if="risk.severity === 'critical'" />
              <Warning v-else-if="risk.severity === 'high'" />
              <InfoFilled v-else />
            </el-icon>
            <div class="risk-info">
              <h3 class="risk-title">{{ risk.title }}</h3>
              <span class="risk-category">{{ risk.category }}</span>
            </div>
            <el-tag :type="getSeverityType(risk.severity)" size="large">
              {{ getSeverityLabel(risk.severity) }}
            </el-tag>
          </div>
          <p class="risk-description">{{ risk.description }}</p>
          <div class="risk-solution">
            <strong>建议解决方案:</strong>
            <p>{{ risk.solution }}</p>
          </div>
        </div>
      </div>
    </el-card>

    <!-- 安全加固建议 -->
    <el-card class="recommendations-card">
      <template #header>
        <span class="card-title">
          <el-icon><List /></el-icon>
          安全加固建议
        </span>
      </template>

      <el-timeline>
        <el-timeline-item
          v-for="(rec, index) in recommendations"
          :key="index"
          :icon="rec.completed ? CircleCheck : More"
          :type="rec.completed ? 'success' : 'primary'"
          :hollow="!rec.completed"
        >
          <div class="recommendation-item">
            <h4>{{ rec.title }}</h4>
            <p>{{ rec.description }}</p>
            <div class="recommendation-actions">
              <el-tag size="small">优先级: {{ rec.priority }}</el-tag>
              <el-button
                v-if="!rec.completed"
                type="primary"
                size="small"
                link
                @click="openRecommendationDetail(rec)"
              >
                查看详情
              </el-button>
            </div>
          </div>
        </el-timeline-item>
      </el-timeline>
    </el-card>

    <!-- 评估历史 -->
    <el-card class="history-card">
      <template #header>
        <div class="card-header">
          <span class="card-title">
            <el-icon><Clock /></el-icon>
            评估历史趋势
          </span>
          <el-radio-group v-model="timeRange" size="small" @change="handleTimeRangeChange">
            <el-radio-button value="24h">24小时</el-radio-button>
            <el-radio-button value="7d">7天</el-radio-button>
            <el-radio-button value="30d">30天</el-radio-button>
          </el-radio-group>
        </div>
      </template>
      <div ref="historyChartRef" class="chart-container"></div>
    </el-card>
  </div>

  <el-dialog
    v-model="recommendationDialogVisible"
    :title="selectedRecommendation?.title || '安全加固建议'"
    width="420px"
  >
    <div v-if="selectedRecommendation">
      <p><strong>描述：</strong>{{ selectedRecommendation.description }}</p>
      <p><strong>优先级：</strong>{{ selectedRecommendation.priority }}</p>
      <p><strong>建议：</strong>{{ selectedRecommendation.details }}</p>
      <p v-if="selectedRecommendation.completed"><strong>状态：</strong>已完成</p>
    </div>
    <template #footer>
      <el-button @click="recommendationDialogVisible = false">关闭</el-button>
    </template>
  </el-dialog>
</template>

<script setup lang="ts">
import { ref, onMounted, nextTick } from 'vue'
import { useRoute } from 'vue-router'
import { ElMessage } from 'element-plus'
import {
  Refresh, Download, Key, DataLine, Connection, Setting,
  Warning, WarningFilled, InfoFilled, List, CircleCheck,
  More, Clock
} from '@element-plus/icons-vue'
import * as echarts from 'echarts'
import type { EChartsOption } from 'echarts'
import api from '@/api'
import jsPDF from 'jspdf'
import html2canvas from 'html2canvas'

const route = useRoute()
const cabinetId = ref(route.params.id as string)
const loading = ref(false)
const exporting = ref(false)

// 时间范围选择
const timeRange = ref<'24h' | '7d' | '30d'>('7d')

// 储能柜信息
const cabinetInfo = ref({
  location: '加载中...',
  status: 'unknown'
})

// 脆弱性评估数据
const assessment = ref({
  overallScore: 0,
  riskLevel: 'unknown',
  licenseCompliance: 0,
  dataAnomaly: 0,
  communicationAnomaly: 0,
  configSecurity: 0,
  lastAssessment: ''
})

// 安全风险列表
const securityRisks = ref<any[]>([])

// 安全加固建议
const recommendations = ref([
  {
    title: '启用TLS加密通信',
    description: '为MQTT和HTTP通信启用TLS加密,保护数据传输安全',
    priority: '高',
    completed: false,
    details: '在 Cloud、Edge、网关三端统一证书，关闭 1883 明文端口并开启证书轮换。'
  },
  {
    title: '定期更新固件版本',
    description: '建立固件更新计划,及时修复已知安全漏洞',
    priority: '高',
    completed: false,
    details: '按季度同步 Edge 固件，先在预生产验证，再通过 API 触发批量升级。'
  },
  {
    title: '配置防火墙规则',
    description: '限制不必要的端口开放,仅允许授权IP访问',
    priority: '中',
    completed: true,
    details: '仅开放 Cloud API、MQTT/TLS 端口，内部服务使用 127.0.0.1 绑定。'
  },
  {
    title: '启用日志审计',
    description: '开启详细的操作日志记录,便于安全事件追溯',
    priority: '中',
    completed: true,
    details: '将 Edge/Cloud 的关键操作推送到 Syslog/SIEM，保留 90 天审计记录。'
  }
])

const recommendationDialogVisible = ref(false)
const selectedRecommendation = ref<any | null>(null)

const openRecommendationDetail = (rec: any) => {
  selectedRecommendation.value = rec
  recommendationDialogVisible.value = true
}

// 历史评估数据
const historyData = ref<any[]>([])

// 加载储能柜信息
const loadCabinetInfo = async () => {
  try {
    const res = await api.cabinet.get(cabinetId.value)
    if (res.data) {
      cabinetInfo.value = {
        location: res.data.location || '未设置',
        status: res.data.status || 'unknown'
      }
    }
  } catch (error: any) {
    console.error('加载储能柜信息失败:', error)
  }
}

const formatScore = (value?: number | null) => {
  if (typeof value === 'number' && Number.isFinite(value)) {
    return Number(value.toFixed(1))
  }
  return 0
}

// 加载最新评估数据
const loadLatestAssessment = async () => {
  try {
    const res = await api.vulnerability.getLatestAssessment(cabinetId.value)
    if (res.data && res.data.assessment) {
      const data = res.data.assessment
      assessment.value = {
        overallScore: formatScore(data.overall_score),
        riskLevel: data.risk_level,
        licenseCompliance: formatScore(data.license_compliance_score),
        dataAnomaly: formatScore(data.data_anomaly_score),
        communicationAnomaly: formatScore(data.communication_score),
        configSecurity: formatScore(data.config_security_score),
        lastAssessment: new Date(data.timestamp).toLocaleString('zh-CN')
      }

      // 处理漏洞事件
      if (res.data.events && res.data.events.length > 0) {
        securityRisks.value = res.data.events.map((event: any) => ({
          id: event.id,
          severity: event.severity,
          category: getCategoryLabel(event.category),
          title: event.title,
          description: event.description,
          solution: event.solution || '暂无解决方案'
        }))
      } else {
        securityRisks.value = []
      }
    }
  } catch (error: any) {
    console.error('加载评估数据失败:', error)
    ElMessage.error(error.message || '加载评估数据失败')
  }
}

// 根据时间范围计算起止时间
const getTimeRange = () => {
  const endTime = new Date()
  const startTime = new Date()
  
  switch (timeRange.value) {
    case '24h':
      startTime.setHours(startTime.getHours() - 24)
      break
    case '7d':
      startTime.setDate(startTime.getDate() - 7)
      break
    case '30d':
      startTime.setDate(startTime.getDate() - 30)
      break
  }
  
  return { startTime, endTime }
}

// 加载历史评估数据
const loadHistoryData = async () => {
  try {
    const { startTime, endTime } = getTimeRange()

    const res = await api.vulnerability.getHistory(cabinetId.value, {
      start_time: startTime.toISOString(),
      end_time: endTime.toISOString(),
      limit: 200  // 增加限制以支持30天数据
    })

    console.log('历史评估数据:', res) // 调试日志

    if (res.data && res.data.length > 0) {
      historyData.value = res.data
      // 使用nextTick确保DOM已更新后再初始化图表
      await nextTick()
      initHistoryChart()
    } else {
      console.warn('没有获取到历史评估数据')
      historyData.value = []
      // 即使没有数据也初始化空图表
      await nextTick()
      initHistoryChart()
    }
  } catch (error: any) {
    console.error('加载历史数据失败:', error)
  }
}

// 处理时间范围变化
const handleTimeRangeChange = () => {
  loadHistoryData()
}

// 获取分类标签
const getCategoryLabel = (category: string) => {
  const labels: Record<string, string> = {
    network: '网络通信',
    config: '配置安全',
    data: '数据质量',
    license: '许可证合规'
  }
  return labels[category] || category
}

// 加载所有数据
const loadData = async () => {
  loading.value = true
  try {
    await Promise.all([
      loadCabinetInfo(),
      loadLatestAssessment(),
      loadHistoryData()
    ])
  } finally {
    loading.value = false
  }
}

// 获取评分类别样式
const getScoreClass = (score: number) => {
  if (score >= 90) return 'excellent'
  if (score >= 70) return 'good'
  if (score >= 50) return 'fair'
  return 'poor'
}

// 获取风险类型
const getRiskType = (level: string) => {
  const types: Record<string, any> = {
    healthy: 'success',
    low: 'success',
    medium: 'warning',
    high: 'danger',
    critical: 'danger'
  }
  return types[level] || 'info'
}

// 获取风险标签
const getRiskLabel = (level: string) => {
  const labels: Record<string, string> = {
    healthy: '健康',
    low: '低风险',
    medium: '中风险',
    high: '高风险',
    critical: '严重'
  }
  return labels[level] || '未知'
}

// 获取进度条颜色
const getProgressColor = (percentage: number) => {
  if (percentage >= 90) return '#10b981'
  if (percentage >= 70) return '#3b82f6'
  if (percentage >= 50) return '#f59e0b'
  return '#ef4444'
}

// 获取严重程度类型
const getSeverityType = (severity: string) => {
  const types: Record<string, any> = {
    critical: 'danger',
    high: 'danger',
    medium: 'warning',
    low: 'info'
  }
  return types[severity] || 'info'
}

// 获取严重程度标签
const getSeverityLabel = (severity: string) => {
  const labels: Record<string, string> = {
    critical: '严重',
    high: '高危',
    medium: '中危',
    low: '低危'
  }
  return labels[severity] || '未知'
}

// 获取许可证状态描述
const getLicenseStatus = () => {
  const score = assessment.value.licenseCompliance
  if (score >= 90) return '许可证状态良好,所有检查通过'
  if (score >= 70) return '许可证即将过期,建议尽快续期'
  return '许可证存在严重问题,需要立即处理'
}

// 获取数据异常状态描述
const getDataAnomalyStatus = () => {
  const score = assessment.value.dataAnomaly
  if (score >= 90) return '数据质量优秀,未检测到异常'
  if (score >= 70) return '检测到少量数据质量问题'
  return '数据异常较多,需要检查传感器'
}

// 获取通信状态描述
const getCommunicationStatus = () => {
  const score = assessment.value.communicationAnomaly
  if (score >= 90) return '通信稳定,连接质量良好'
  if (score >= 70) return '偶有短暂断连,整体稳定'
  return '通信不稳定,频繁断连'
}

// 获取配置安全状态描述
const getConfigSecurityStatus = () => {
  const score = assessment.value.configSecurity
  if (score >= 90) return '配置安全性良好,符合最佳实践'
  if (score >= 70) return '存在一些安全配置建议'
  return '配置存在安全隐患,需要加固'
}

// 刷新数据
const refreshData = async () => {
  loading.value = true
  try {
    await loadData()
    ElMessage.success('数据刷新成功')
  } catch (error) {
    ElMessage.error('数据刷新失败')
  } finally {
    loading.value = false
  }
}

// 导出PDF报告
const exportPDF = async () => {
  exporting.value = true
  try {
    ElMessage.info('正在生成PDF报告,请稍候...')

    // 获取页面元素
    const element = document.querySelector('.vulnerability-detail-page') as HTMLElement
    if (!element) {
      throw new Error('未找到页面元素')
    }

    // 隐藏不需要导出的元素 (面包屑和操作按钮)
    const breadcrumb = element.querySelector('.breadcrumb') as HTMLElement
    const headerActions = element.querySelector('.header-actions') as HTMLElement
    const originalBreadcrumbDisplay = breadcrumb ? breadcrumb.style.display : ''
    const originalActionsDisplay = headerActions ? headerActions.style.display : ''

    if (breadcrumb) breadcrumb.style.display = 'none'
    if (headerActions) headerActions.style.display = 'none'

    // 使用html2canvas将页面转换为图片
    const canvas = await html2canvas(element, {
      scale: 2, // 提高清晰度
      useCORS: true,
      logging: false,
      backgroundColor: '#f8fafc'
    })

    // 恢复隐藏的元素
    if (breadcrumb) breadcrumb.style.display = originalBreadcrumbDisplay
    if (headerActions) headerActions.style.display = originalActionsDisplay

    // 创建PDF
    const imgWidth = 210 // A4纸宽度(mm)
    const pageHeight = 297 // A4纸高度(mm)
    const imgHeight = (canvas.height * imgWidth) / canvas.width
    let heightLeft = imgHeight

    const pdf = new jsPDF('p', 'mm', 'a4')
    let position = 0

    // 添加图片到PDF
    const imgData = canvas.toDataURL('image/png')
    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight)
    heightLeft -= pageHeight

    // 如果内容超过一页,添加新页
    while (heightLeft > 0) {
      position = heightLeft - imgHeight
      pdf.addPage()
      pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight)
      heightLeft -= pageHeight
    }

    // 生成文件名
    const fileName = `脆弱性评估报告_${cabinetId.value}_${new Date().toISOString().slice(0, 10)}.pdf`

    // 保存PDF
    pdf.save(fileName)

    ElMessage.success('PDF报告导出成功')
  } catch (error: any) {
    console.error('导出PDF失败:', error)
    ElMessage.error(error.message || '导出PDF失败,请重试')
  } finally {
    exporting.value = false
  }
}

// 图表引用
const historyChartRef = ref<HTMLDivElement>()

// 格式化日期标签
const formatDateLabel = (timestamp: string) => {
  const date = new Date(timestamp)
  if (timeRange.value === '24h') {
    // 24小时内显示时:分
    return date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' })
  } else if (timeRange.value === '7d') {
    // 7天内显示月/日 时:分
    return date.toLocaleDateString('zh-CN', { month: '2-digit', day: '2-digit' }) + ' ' +
           date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' })
  } else {
    // 30天显示月/日
    return date.toLocaleDateString('zh-CN', { month: '2-digit', day: '2-digit' })
  }
}

// 初始化历史趋势图
const initHistoryChart = () => {
  console.log('初始化历史图表, DOM ref:', !!historyChartRef.value, ', 数据长度:', historyData.value.length)
  
  if (!historyChartRef.value) {
    console.warn('图表DOM元素未准备好')
    return
  }

  // 获取或创建图表实例
  let chart = echarts.getInstanceByDom(historyChartRef.value)
  if (!chart) {
    chart = echarts.init(historyChartRef.value)
  }
  
  if (historyData.value.length === 0) {
    console.warn('没有历史数据可显示')
    // 显示空状态图表
    chart.setOption({
      title: {
        text: '暂无评估历史数据',
        left: 'center',
        top: 'center',
        textStyle: { color: '#999', fontSize: 14 }
      }
    })
    return
  }

  // 处理历史数据 - 根据时间范围格式化日期
  const dates = historyData.value.map(item => formatDateLabel(item.timestamp))
  const overallScores = historyData.value.map(item => Math.round(item.overall_score))
  const licenseScores = historyData.value.map(item => Math.round(item.license_compliance_score))
  const dataScores = historyData.value.map(item => Math.round(item.data_anomaly_score))
  const commScores = historyData.value.map(item => Math.round(item.communication_score))
  const configScores = historyData.value.map(item => Math.round(item.config_security_score))

  const option: EChartsOption = {
    tooltip: {
      trigger: 'axis',
      backgroundColor: 'rgba(255, 255, 255, 0.95)',
      borderColor: '#e2e8f0',
      borderWidth: 1,
      textStyle: { color: '#475569' }
    },
    legend: {
      data: ['综合评分', '许可证', '数据异常', '通信异常', '配置安全'],
      bottom: 0
    },
    grid: {
      left: '3%',
      right: '4%',
      bottom: '12%',
      top: '3%',
      containLabel: true
    },
    xAxis: {
      type: 'category',
      boundaryGap: false,
      data: dates
    },
    yAxis: {
      type: 'value',
      name: '评分',
      min: 0,
      max: 100
    },
    series: [
      {
        name: '综合评分',
        type: 'line',
        data: overallScores,
        smooth: true,
        lineStyle: { width: 3, color: '#3b82f6' }
      },
      {
        name: '许可证',
        type: 'line',
        data: licenseScores,
        smooth: true,
        lineStyle: { width: 2, color: '#10b981' }
      },
      {
        name: '数据异常',
        type: 'line',
        data: dataScores,
        smooth: true,
        lineStyle: { width: 2, color: '#f59e0b' }
      },
      {
        name: '通信异常',
        type: 'line',
        data: commScores,
        smooth: true,
        lineStyle: { width: 2, color: '#ef4444' }
      },
      {
        name: '配置安全',
        type: 'line',
        data: configScores,
        smooth: true,
        lineStyle: { width: 2, color: '#8b5cf6' }
      }
    ]
  }

  chart.setOption(option)
}

onMounted(() => {
  loadData()
})
</script>

<style scoped>
.vulnerability-detail-page {
  padding: 24px;
  background: #f8fafc;
  min-height: 100vh;
}

/* 面包屑 */
.breadcrumb {
  margin-bottom: 16px;
  font-size: 15px;
}

/* 页面头部 */
.page-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 24px;
}

.header-content .title {
  margin: 0 0 4px 0;
  font-size: 28px;
  color: #0f172a;
  font-weight: 700;
  letter-spacing: -0.5px;
}

.header-content .subtitle {
  margin: 0;
  font-size: 15px;
  color: #64748b;
}

.header-actions {
  display: flex;
  gap: 12px;
}

/* 综合评分卡片 */
.score-card {
  margin-bottom: 24px;
  border-radius: 12px;
  border: 1px solid #e2e8f0;
}

.score-overview {
  display: flex;
  gap: 48px;
}

.overall-score {
  display: flex;
  align-items: center;
  gap: 24px;
  padding: 24px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border-radius: 12px;
  flex-shrink: 0;
}

.score-circle {
  width: 120px;
  height: 120px;
  border-radius: 50%;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  background: rgba(255, 255, 255, 0.95);
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
}

.score-value {
  font-size: 48px;
  font-weight: 700;
  line-height: 1;
}

.score-suffix {
  font-size: 16px;
  font-weight: 600;
  margin-top: 4px;
}

.score-circle.excellent .score-value {
  color: #10b981;
}

.score-circle.good .score-value {
  color: #3b82f6;
}

.score-circle.fair .score-value {
  color: #f59e0b;
}

.score-circle.poor .score-value {
  color: #ef4444;
}

.score-info {
  color: white;
}

.score-info h2 {
  margin: 0 0 12px 0;
  font-size: 24px;
  font-weight: 700;
}

.assessment-time {
  margin: 12px 0 0 0;
  font-size: 14px;
  opacity: 0.9;
}

/* 维度评分 */
.dimension-scores {
  flex: 1;
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 24px;
}

.dimension-item {
  padding: 20px;
  background: white;
  border-radius: 10px;
  border: 1px solid #e2e8f0;
}

.dimension-header {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 12px;
}

.dimension-icon {
  font-size: 20px;
  color: #3b82f6;
}

.dimension-name {
  flex: 1;
  font-size: 16px;
  font-weight: 600;
  color: #0f172a;
}

.dimension-weight {
  font-size: 14px;
  font-weight: 600;
  color: #64748b;
}

.dimension-desc {
  margin: 8px 0 0 0;
  font-size: 14px;
  color: #64748b;
}

/* 风险列表 */
.risks-card {
  margin-bottom: 24px;
  border-radius: 12px;
  border: 1px solid #e2e8f0;
}

:deep(.el-card__header) {
  border-bottom: 1px solid #e2e8f0;
  padding: 16px 20px;
  background: #fafbfc;
}

.card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.card-title {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 17px;
  font-weight: 600;
  color: #0f172a;
}

.risks-list {
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.risk-item {
  padding: 20px;
  border-radius: 10px;
  border: 2px solid #e2e8f0;
  transition: all 0.3s;
}

.risk-item:hover {
  border-color: #cbd5e1;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
}

.risk-item.risk-critical {
  border-color: #fecaca;
  background: #fef2f2;
}

.risk-item.risk-high {
  border-color: #fecaca;
  background: #fffbeb;
}

.risk-header {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 12px;
}

.risk-icon {
  font-size: 24px;
}

.risk-icon.severity-critical {
  color: #ef4444;
}

.risk-icon.severity-high {
  color: #f59e0b;
}

.risk-info {
  flex: 1;
}

.risk-title {
  margin: 0 0 4px 0;
  font-size: 17px;
  font-weight: 600;
  color: #0f172a;
}

.risk-category {
  font-size: 13px;
  color: #64748b;
}

.risk-description {
  margin: 0 0 12px 0;
  font-size: 15px;
  color: #475569;
  line-height: 1.6;
}

.risk-solution {
  padding: 12px;
  background: #f8fafc;
  border-radius: 8px;
  font-size: 14px;
  color: #475569;
}

.risk-solution strong {
  color: #0f172a;
}

.risk-solution p {
  margin: 4px 0 0 0;
}

/* 建议卡片 */
.recommendations-card {
  margin-bottom: 24px;
  border-radius: 12px;
  border: 1px solid #e2e8f0;
}

.recommendation-item h4 {
  margin: 0 0 8px 0;
  font-size: 16px;
  font-weight: 600;
  color: #0f172a;
}

.recommendation-item p {
  margin: 0 0 8px 0;
  font-size: 14px;
  color: #64748b;
}

.recommendation-actions {
  display: flex;
  align-items: center;
  gap: 12px;
}

/* 历史卡片 */
.history-card {
  border-radius: 12px;
  border: 1px solid #e2e8f0;
}

.chart-container {
  width: 100%;
  height: 320px;
  min-height: 320px;
}

/* 响应式 */
@media (max-width: 1024px) {
  .score-overview {
    flex-direction: column;
  }

  .dimension-scores {
    grid-template-columns: 1fr;
  }
}

@media (max-width: 768px) {
  .vulnerability-detail-page {
    padding: 16px;
  }

  .page-header {
    flex-direction: column;
    align-items: flex-start;
    gap: 12px;
  }

  .header-content .title {
    font-size: 22px;
  }
}
</style>
