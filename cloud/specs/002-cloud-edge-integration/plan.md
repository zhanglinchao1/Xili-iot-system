# Implementation Plan: Cloud-Edge System Integration (Phase 9)

**Feature**: 002-cloud-edge-integration  
**Created**: 2025-11-04  
**Sprint**: Phase 9  

---

## ğŸ¯ Technical Context

### Problem Statement

å½“å‰ Cloud ç«¯ç³»ç»Ÿå·²å®ç°æ ¸å¿ƒåŠŸèƒ½ï¼ˆPhase 1-7ï¼‰ï¼Œä½†ä¸ Edge ç«¯çš„é›†æˆå°šæœªå®Œæˆã€‚ä¸»è¦é—®é¢˜ï¼š

1. **æ•°æ®æµæ–­è£‚**ï¼šEdge ç«¯é‡‡é›†çš„ä¼ æ„Ÿå™¨æ•°æ®æ— æ³•åŒæ­¥åˆ° Cloud ç«¯
2. **æŒ‡ä»¤æ— æ³•ä¸‹è¾¾**ï¼šCloud ç«¯æ— æ³•å‘ Edge ç«¯ä¸‹å‘é…ç½®æ›´æ–°å’Œæ§åˆ¶æŒ‡ä»¤
3. **è®¸å¯è¯ç®¡ç†è„±èŠ‚**ï¼šCloud ç«¯è®¸å¯è¯ç­¾å‘åï¼ŒEdge ç«¯æ— æ³•å®æ—¶éªŒè¯å’Œæ›´æ–°
4. **ç›‘æ§ç›²åŒº**ï¼šCloud ç«¯æ— æ³•å®æ—¶ç›‘æ§ Edge ç«¯çŠ¶æ€å’Œå‘Šè­¦

### Solution Overview

å®ç°å®Œæ•´çš„ Cloud-Edge è”è°ƒæ–¹æ¡ˆï¼ŒåŒ…æ‹¬ï¼š

1. **Edgeâ†’Cloud æ•°æ®åŒæ­¥**
   - å®ç° HTTP API æ¥æ”¶ Edge ç«¯æ‰¹é‡æ•°æ®ï¼ˆ`POST /api/v1/cabinets/:cabinet_id/sync`ï¼‰
   - æ”¯æŒä¼ æ„Ÿå™¨æ•°æ®ã€è®¾å¤‡çŠ¶æ€ã€å‘Šè­¦ä¿¡æ¯çš„æ‰¹é‡æ’å…¥
   - ä½¿ç”¨ API Key è®¤è¯å’Œè®¸å¯è¯éªŒè¯

2. **Cloudâ†’Edge æŒ‡ä»¤ä¸‹å‘**
   - è°ƒæ•´ MQTT Topic å‘½åä»¥åŒ¹é… Edge ç«¯è§„èŒƒ
   - å®ç°æŒ‡ä»¤åˆ†ç±»è·¯ç”±ï¼ˆconfig/license/query/controlï¼‰
   - å®ç° MQTT å“åº”è®¢é˜…å’ŒçŠ¶æ€æ›´æ–°

3. **è®¸å¯è¯ç®¡ç†å¢å¼º**
   - å®ç°è®¸å¯è¯éªŒè¯ APIï¼ˆ`POST /api/v1/license/validate`ï¼‰
   - å®ç° MQTT è®¸å¯è¯æ¨é€
   - å®ç°è®¸å¯è¯ç¼“å­˜å’Œå¿«é€ŸéªŒè¯

4. **Edge çŠ¶æ€ç›‘æ§**
   - å®ç° Edge æŸœè¿æ¥çŠ¶æ€è·Ÿè¸ª
   - å®ç°å‘Šè­¦èšåˆå’Œåˆ†æ
   - å®ç° Web ç•Œé¢å±•ç¤º

---

## ğŸ—ï¸ Architecture

### System Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       Cloud ç«¯ç³»ç»Ÿæ¶æ„                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                 Web Layer (Frontend)                       â”‚ â”‚
â”‚  â”‚  - Vue.js 3 + Element Plus                                â”‚ â”‚
â”‚  â”‚  - Edge ç®¡ç†é¡µé¢                                           â”‚ â”‚
â”‚  â”‚  - æŒ‡ä»¤ä¸‹å‘ç•Œé¢                                            â”‚ â”‚
â”‚  â”‚  - å®æ—¶ç›‘æ§ Dashboard                                      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                         â”‚ HTTP/WebSocket                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                 API Layer (Backend)                        â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚ â”‚
â”‚  â”‚  â”‚ Edge Sync    â”‚  â”‚ License      â”‚  â”‚ Command         â”‚â”‚ â”‚
â”‚  â”‚  â”‚ Handler      â”‚  â”‚ Validation   â”‚  â”‚ Handler         â”‚â”‚ â”‚
â”‚  â”‚  â”‚              â”‚  â”‚ API          â”‚  â”‚                 â”‚â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚ â”‚
â”‚  â”‚         â”‚                  â”‚                   â”‚          â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚            â”‚                  â”‚                   â”‚            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚               Service Layer (Business Logic)              â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚ â”‚
â”‚  â”‚  â”‚ EdgeSync     â”‚  â”‚ License      â”‚  â”‚ Command         â”‚â”‚ â”‚
â”‚  â”‚  â”‚ Service      â”‚  â”‚ Service      â”‚  â”‚ Service         â”‚â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚ â”‚
â”‚  â”‚         â”‚                  â”‚                   â”‚          â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚            â”‚                  â”‚                   â”‚            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚             Repository Layer (Data Access)                â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚ â”‚
â”‚  â”‚  â”‚ EdgeCabinet  â”‚  â”‚ EdgeSync     â”‚  â”‚ CloudCommand    â”‚â”‚ â”‚
â”‚  â”‚  â”‚ Repository   â”‚  â”‚ Repository   â”‚  â”‚ Repository      â”‚â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚               Infrastructure Layer                        â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚ â”‚
â”‚  â”‚  â”‚ PostgreSQL   â”‚  â”‚ TimescaleDB  â”‚  â”‚ Redis           â”‚â”‚ â”‚
â”‚  â”‚  â”‚ (Metadata)   â”‚  â”‚ (Timeseries) â”‚  â”‚ (Cache)         â”‚â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚ â”‚
â”‚  â”‚                                                           â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚ â”‚
â”‚  â”‚  â”‚            MQTT Client (Pub/Sub)                     â”‚â”‚ â”‚
â”‚  â”‚  â”‚  - Publish: cloud/cabinets/{id}/commands/{category}  â”‚â”‚ â”‚
â”‚  â”‚  â”‚  - Subscribe: cloud/cabinets/+/responses/+           â”‚â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â–² â–¼
                         MQTT Broker
                         (Mosquitto)
                              â–² â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       Edge ç«¯ç³»ç»Ÿæ¶æ„                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚            MQTT Client (Pub/Sub)                         â”‚ â”‚
â”‚  â”‚  - Subscribe: cloud/cabinets/{id}/commands/#             â”‚ â”‚
â”‚  â”‚  - Publish: cloud/cabinets/{id}/responses/{cmd_id}       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚            Cloud Sync Service                            â”‚ â”‚
â”‚  â”‚  - HTTP Client: POST /api/v1/cabinets/:id/sync           â”‚ â”‚
â”‚  â”‚  - API Key Authentication                                â”‚ â”‚
â”‚  â”‚  - Retry Mechanism (3 times)                             â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚            License Service                               â”‚ â”‚
â”‚  â”‚  - Validation: POST /api/v1/license/validate             â”‚ â”‚
â”‚  â”‚  - Local Cache: license_cache.json                       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ” Technical Research

### Current State Analysis

#### Cloud ç«¯å·²å®ç°åŠŸèƒ½ï¼ˆPhase 1-7ï¼‰

âœ… **Phase 1: é¡¹ç›®åˆå§‹åŒ–**
- Go æ¨¡å—ã€é…ç½®æ–‡ä»¶ã€é¡¹ç›®ç»“æ„

âœ… **Phase 2: åŸºç¡€è®¾æ–½**
- PostgreSQL + TimescaleDB è¿æ¥
- Redis è¿æ¥ï¼ˆå¯é€‰ï¼‰
- MQTT Clientï¼ˆéœ€è¦è°ƒæ•´ï¼‰
- JWT ä¸­é—´ä»¶
- æ—¥å¿—ç³»ç»Ÿ

âœ… **Phase 3: å‚¨èƒ½æŸœç®¡ç†**
- Cabinet CRUD API
- å‰ç«¯åˆ—è¡¨å’Œè¯¦æƒ…é¡µ

âœ… **Phase 4: ä¼ æ„Ÿå™¨æ•°æ®ç®¡ç†**
- Sensor Device å’Œ Sensor Data æ¨¡å‹
- å†å²æ•°æ®æŸ¥è¯¢ API
- å‰ç«¯æ•°æ®å±•ç¤ºé¡µ

âœ… **Phase 5: å‘½ä»¤ä¸‹å‘**
- Command Service
- MQTT Publishï¼ˆéœ€è¦è°ƒæ•´ Topicï¼‰

âœ… **Phase 6: è®¸å¯è¯ç®¡ç†**
- License CRUD API
- License Serviceï¼ˆéœ€è¦å¢åŠ éªŒè¯ APIï¼‰

âœ… **Phase 7: å‘Šè­¦ç®¡ç†**
- Alert CRUD API
- Health Score è®¡ç®—

#### Cloud ç«¯ç¼ºå¤±åŠŸèƒ½ï¼ˆPhase 9ï¼‰

âŒ **Edge æ•°æ®åŒæ­¥**
- Edge Sync Handlerï¼ˆæ¥æ”¶ Edge æ‰¹é‡æ•°æ®ï¼‰
- Edge Sync Repository
- Edge Sync Service

âŒ **MQTT å“åº”è®¢é˜…**
- MQTT Subscriberï¼ˆè®¢é˜… Edge å“åº”ï¼‰
- Response Handler
- Command Status Updater

âŒ **è®¸å¯è¯éªŒè¯ API**
- Validation Endpoint
- Fast Cache Lookup

âŒ **Edge çŠ¶æ€ç›‘æ§**
- Edge Cabinet Status Tracker
- Connection Status Monitor
- Alert Aggregation

### Gap Analysis

| åŠŸèƒ½ | Edge ç«¯ API | Cloud ç«¯å½“å‰çŠ¶æ€ | éœ€è¦å®ç° |
|------|-----------|----------------|---------|
| æ•°æ®åŒæ­¥ç«¯ç‚¹ | `POST /api/v1/cabinets/:id/sync` | âŒ æœªå®ç° | âœ… éœ€è¦å®ç° |
| è®¸å¯è¯éªŒè¯ | `POST /api/v1/license/validate` | âŒ æœªå®ç° | âœ… éœ€è¦å®ç° |
| MQTT Topic | `cloud/cabinets/{id}/commands/{cat}` | âš ï¸ éƒ¨åˆ†å®ç°ï¼ˆTopic ä¸åŒ¹é…ï¼‰ | âœ… éœ€è¦è°ƒæ•´ |
| MQTT å“åº”è®¢é˜… | `cloud/cabinets/{id}/responses/{cmd_id}` | âŒ æœªå®ç° | âœ… éœ€è¦å®ç° |
| Edge çŠ¶æ€è·Ÿè¸ª | N/Aï¼ˆé€šè¿‡å¿ƒè·³æ¨æ–­ï¼‰ | âŒ æœªå®ç° | âœ… éœ€è¦å®ç° |

---

## ğŸ“‹ Constitution Check

### Alignment with Project Principles

#### âœ… Principle I: Cloud-Edge Synergy First

**ç¬¦åˆåº¦**: 100%

- Edge ç«¯è´Ÿè´£è®¾å¤‡çº§æ•°æ®é‡‡é›†ï¼ŒCloud ç«¯è´Ÿè´£é›†ç¾¤çº§ç®¡ç† âœ…
- æ”¯æŒé™çº§æ¨¡å¼ï¼šEdge ç«¯å¯ç‹¬ç«‹è¿è¡Œ 24 å°æ—¶ âœ…
- Cloud ç«¯ä¸ç›´æ¥ç®¡ç†å•ä¸ªä¼ æ„Ÿå™¨ âœ…

#### âœ… Principle II: Data-Driven & Real-Time Monitoring

**ç¬¦åˆåº¦**: 100%

- åŸºäº Edge ç«¯çš„ `CloudSyncPayload` æ•°æ®ç»“æ„ âœ…
- æ”¯æŒæ‰¹é‡åŒæ­¥ï¼ˆHTTP, 5 åˆ†é’Ÿï¼‰å’Œå®æ—¶æŒ‡ä»¤ï¼ˆMQTT, ç§’çº§ï¼‰ âœ…
- ä¿ç•™å®Œæ•´çš„æ—¶åºä¿¡æ¯å’Œè´¨é‡æŒ‡æ ‡ âœ…

#### âœ… Principle III: Security & Access Control

**ç¬¦åˆåº¦**: 100%

- API Key è®¤è¯ï¼ˆEdgeâ†’Cloud æ•°æ®åŒæ­¥ï¼‰ âœ…
- è®¸å¯è¯éªŒè¯ï¼ˆCabinet ID + MAC åœ°å€ç»‘å®šï¼‰ âœ…
- MQTT over TLSï¼ˆCloudâ†’Edge æŒ‡ä»¤ä¸‹å‘ï¼‰ âœ…
- å®¡è®¡æ—¥å¿—ï¼ˆæ‰€æœ‰å…³é”®æ“ä½œï¼‰ âœ…

#### âœ… Principle IV: Observability & Fault Tolerance

**ç¬¦åˆåº¦**: 100%

- ç»“æ„åŒ–æ—¥å¿—ï¼ˆZapï¼‰ âœ…
- è¿æ¥çŠ¶æ€ç›‘æ§ âœ…
- è¶…æ—¶å’Œé‡è¯•æœºåˆ¶ âœ…
- ä¼˜é›…é™çº§ âœ…

#### âœ… Principle V: Test-First Development

**ç¬¦åˆåº¦**: 100%

- å•å…ƒæµ‹è¯•ï¼ˆè¦†ç›–ç‡ â‰¥70%ï¼‰ âœ…
- é›†æˆæµ‹è¯•ï¼ˆAPI + MQTTï¼‰ âœ…
- åˆçº¦æµ‹è¯•ï¼ˆEdge-Cloud åè®®ï¼‰ âœ…

---

## ğŸ“ Design Decisions

### Decision 1: MQTT Topic Naming Convention

**é—®é¢˜**: å½“å‰ Cloud ç«¯ä½¿ç”¨ `cloud/commands/{cabinet_id}`ï¼Œè€Œ Edge ç«¯æœŸæœ› `cloud/cabinets/{cabinet_id}/commands/{category}`

**å†³ç­–**: è°ƒæ•´ Cloud ç«¯çš„ MQTT Topic ä»¥åŒ¹é… Edge ç«¯è§„èŒƒ

**ç†ç”±**:
- Edge ç«¯è§„èŒƒæ›´æ¸…æ™°ï¼ˆæŒ‰ category åˆ†ç±»ï¼‰
- Edge ç«¯å·²éƒ¨ç½²ï¼Œä¿®æ”¹æˆæœ¬é«˜
- Cloud ç«¯ä¿®æ”¹æˆæœ¬ä½ï¼ˆåªéœ€ä¿®æ”¹ Topic æ‹¼æ¥é€»è¾‘ï¼‰

**å®æ–½**:
```go
// Old
topic := fmt.Sprintf("cloud/commands/%s", cabinetID)

// New
topic := fmt.Sprintf("cloud/cabinets/%s/commands/%s", cabinetID, category)
// category: config | license | query | control
```

---

### Decision 2: Edge Sync Data Storage Strategy

**é—®é¢˜**: Edge ç«¯æ‰¹é‡åŒæ­¥çš„æ•°æ®åŒ…å«å¤šç§ç±»å‹ï¼ˆä¼ æ„Ÿå™¨æ•°æ®ã€è®¾å¤‡çŠ¶æ€ã€å‘Šè­¦ï¼‰ï¼Œå¦‚ä½•é«˜æ•ˆå­˜å‚¨ï¼Ÿ

**å†³ç­–**: æŒ‰æ•°æ®ç±»å‹åˆ†è¡¨å­˜å‚¨ï¼Œä½¿ç”¨äº‹åŠ¡ä¿è¯ä¸€è‡´æ€§

**ç†ç”±**:
- ä¼ æ„Ÿå™¨æ•°æ®ï¼ˆæ—¶åºï¼‰â†’ TimescaleDB (`sensor_data`)
- è®¾å¤‡çŠ¶æ€ï¼ˆå…³ç³»ï¼‰â†’ PostgreSQL (`sensor_devices`)
- å‘Šè­¦ä¿¡æ¯ï¼ˆå…³ç³»ï¼‰â†’ PostgreSQL (`alerts`)
- åˆ†è¡¨å­˜å‚¨ä¾¿äºæŸ¥è¯¢ä¼˜åŒ–å’Œæ•°æ®æ¸…ç†

**å®æ–½**:
```go
// Edge Sync Service
func (s *EdgeSyncService) SyncData(ctx context.Context, payload *EdgeSyncPayload) error {
    tx, _ := s.db.Begin(ctx)
    defer tx.Rollback(ctx)
    
    // 1. æ›´æ–°è®¾å¤‡çŠ¶æ€
    s.deviceRepo.BatchUpdate(ctx, tx, payload.Devices)
    
    // 2. æ’å…¥ä¼ æ„Ÿå™¨æ•°æ®ï¼ˆTimescaleDBï¼‰
    s.sensorDataRepo.BatchInsert(ctx, tx, payload.SensorData)
    
    // 3. æ’å…¥å‘Šè­¦ä¿¡æ¯
    s.alertRepo.BatchInsert(ctx, tx, payload.Alerts)
    
    return tx.Commit(ctx)
}
```

---

### Decision 3: License Validation Caching Strategy

**é—®é¢˜**: è®¸å¯è¯éªŒè¯é¢‘ç‡é«˜ï¼ˆæ¯æ¬¡ Edge æ•°æ®åŒæ­¥éƒ½éœ€éªŒè¯ï¼‰ï¼Œå¦‚ä½•å‡å°‘æ•°æ®åº“å‹åŠ›ï¼Ÿ

**å†³ç­–**: ä½¿ç”¨ Redis ç¼“å­˜æœ‰æ•ˆè®¸å¯è¯ï¼ŒTTL è®¾ä¸º 5 åˆ†é’Ÿ

**ç†ç”±**:
- è®¸å¯è¯å˜æ›´é¢‘ç‡ä½ï¼ˆå‡ å¤©/å‡ å‘¨ï¼‰
- 5 åˆ†é’Ÿ TTL å¹³è¡¡æ€§èƒ½å’Œå®æ—¶æ€§
- Redis å¤±è´¥æ—¶é™çº§åˆ°æ•°æ®åº“æŸ¥è¯¢

**å®æ–½**:
```go
func (s *LicenseService) ValidateLicense(ctx context.Context, cabinetID string) (*License, error) {
    // 1. å°è¯•ä» Redis è·å–
    if lic, err := s.cache.Get(ctx, "license:"+cabinetID); err == nil {
        return lic, nil
    }
    
    // 2. ä»æ•°æ®åº“æŸ¥è¯¢
    lic, err := s.repo.GetByCabinetID(ctx, cabinetID)
    if err != nil {
        return nil, err
    }
    
    // 3. éªŒè¯æœ‰æ•ˆæ€§
    if err := s.verifyLicense(lic); err != nil {
        return nil, err
    }
    
    // 4. ç¼“å­˜åˆ° Redisï¼ˆ5 åˆ†é’Ÿï¼‰
    s.cache.Set(ctx, "license:"+cabinetID, lic, 5*time.Minute)
    
    return lic, nil
}
```

---

### Decision 4: Command Response Handling

**é—®é¢˜**: Edge ç«¯é€šè¿‡ MQTT å“åº”æŒ‡ä»¤ï¼ŒCloud ç«¯å¦‚ä½•å…³è” request å’Œ responseï¼Ÿ

**å†³ç­–**: ä½¿ç”¨ `command_id`ï¼ˆUUIDï¼‰ä½œä¸ºå…³è”é”®

**å®æ–½**:
1. Cloud ç«¯å‘é€æŒ‡ä»¤æ—¶ç”Ÿæˆ `command_id`
2. Edge ç«¯å“åº”æ—¶æºå¸¦ç›¸åŒçš„ `command_id`
3. Cloud ç«¯è®¢é˜… `cloud/cabinets/+/responses/+`ï¼Œä» Topic æˆ– Payload ä¸­æå– `command_id`
4. æ›´æ–°æ•°æ®åº“ä¸­å¯¹åº”æŒ‡ä»¤çš„çŠ¶æ€

```go
// MQTT Response Handler
func (h *ResponseHandler) HandleMessage(client mqtt.Client, msg mqtt.Message) {
    var response CommandResponse
    json.Unmarshal(msg.Payload(), &response)
    
    // æ›´æ–°æŒ‡ä»¤çŠ¶æ€
    h.commandRepo.UpdateStatus(ctx, response.CommandID, response.Status, response.Data)
    
    // è®°å½•æ—¥å¿—
    h.logger.Info("Command response received", 
        zap.String("command_id", response.CommandID),
        zap.String("status", response.Status))
}
```

---

## ğŸ—ƒï¸ Data Model

è¯¦è§ `data-model.md`

---

## ğŸ”— API Contracts

è¯¦è§ `contracts/openapi-edge-integration.yaml`

---

## ğŸ“ Implementation Tasks

### Phase 9.1: Edge Sync Implementation (P0)

**ç›®æ ‡**: å®ç° Edgeâ†’Cloud æ•°æ®åŒæ­¥

**ä»»åŠ¡åˆ—è¡¨**:

1. **[T200] [P] åˆ›å»º Edge Sync æ•°æ®æ¨¡å‹**
   - æ–‡ä»¶: `internal/models/edge_sync.go`
   - å†…å®¹: `EdgeSyncPayload`, `EdgeSyncResult`, `EdgeDevice`, `EdgeSensorData`, `EdgeAlert`
   - é¢„è®¡: 1 å°æ—¶

2. **[T201] [P] å®ç° Edge Cabinet Repository**
   - æ–‡ä»¶: `internal/repository/edge_cabinet_repository.go`
   - æ–‡ä»¶: `internal/repository/postgres/edge_cabinet_repo.go`
   - å†…å®¹: CRUD æ“ä½œã€è¿æ¥çŠ¶æ€æ›´æ–°ã€æœ€ååŒæ­¥æ—¶é—´æ›´æ–°
   - é¢„è®¡: 2 å°æ—¶

3. **[T202] [P] å®ç° Edge Sync Service**
   - æ–‡ä»¶: `internal/services/edge_sync_service.go`
   - å†…å®¹: æ‰¹é‡æ•°æ®å¤„ç†ã€äº‹åŠ¡ç®¡ç†ã€æ•°æ®éªŒè¯
   - ä¾èµ–: T200, T201
   - é¢„è®¡: 3 å°æ—¶

4. **[T203] [P] å®ç° Edge Sync API Handler**
   - æ–‡ä»¶: `internal/api/handlers/edge_sync.go`
   - å†…å®¹: `POST /api/v1/cabinets/:cabinet_id/sync` ç«¯ç‚¹
   - ä¾èµ–: T202
   - é¢„è®¡: 2 å°æ—¶

5. **[T204] [P] é›†æˆ Edge Sync è·¯ç”±**
   - æ–‡ä»¶: `internal/api/routes.go`
   - å†…å®¹: æ³¨å†Œ Edge Sync è·¯ç”±
   - ä¾èµ–: T203
   - é¢„è®¡: 0.5 å°æ—¶

6. **[T205] [P] ç¼–å†™ Edge Sync å•å…ƒæµ‹è¯•**
   - æ–‡ä»¶: `internal/services/edge_sync_service_test.go`
   - ä¾èµ–: T202
   - é¢„è®¡: 2 å°æ—¶

---

### Phase 9.2: MQTT Topic Adjustment (P0)

**ç›®æ ‡**: è°ƒæ•´ MQTT Topic ä»¥åŒ¹é… Edge ç«¯è§„èŒƒ

**ä»»åŠ¡åˆ—è¡¨**:

7. **[T206] [P] è°ƒæ•´ Command Service MQTT Topic**
   - æ–‡ä»¶: `internal/services/command_service.go`
   - å†…å®¹: ä¿®æ”¹ Topic æ‹¼æ¥é€»è¾‘ï¼Œæ”¯æŒ category å‚æ•°
   - é¢„è®¡: 1 å°æ—¶

8. **[T207] [P] å®ç° MQTT Response Subscriber**
   - æ–‡ä»¶: `internal/mqtt/response_subscriber.go`
   - å†…å®¹: è®¢é˜… `cloud/cabinets/+/responses/+`ï¼Œè§£æå“åº”ï¼Œæ›´æ–°æŒ‡ä»¤çŠ¶æ€
   - é¢„è®¡: 2 å°æ—¶

9. **[T208] [P] é›†æˆ MQTT Response Subscriber**
   - æ–‡ä»¶: `cmd/cloud-server/main.go`
   - å†…å®¹: å¯åŠ¨ Response Subscriber
   - ä¾èµ–: T207
   - é¢„è®¡: 0.5 å°æ—¶

10. **[T209] [P] ç¼–å†™ MQTT é›†æˆæµ‹è¯•**
    - æ–‡ä»¶: `internal/mqtt/integration_test.go`
    - ä¾èµ–: T206, T207
    - é¢„è®¡: 2 å°æ—¶

---

### Phase 9.3: License Validation API (P0)

**ç›®æ ‡**: å®ç°è®¸å¯è¯éªŒè¯ API

**ä»»åŠ¡åˆ—è¡¨**:

11. **[T210] [P] æ‰©å±• License Service**
    - æ–‡ä»¶: `internal/services/license_service.go`
    - å†…å®¹: æ·»åŠ  `ValidateLicense` æ–¹æ³•ï¼Œæ”¯æŒ Cabinet ID + MAC åœ°å€éªŒè¯
    - é¢„è®¡: 1 å°æ—¶

12. **[T211] [P] å®ç° License Validation Handler**
    - æ–‡ä»¶: `internal/api/handlers/license.go`
    - å†…å®¹: `POST /api/v1/license/validate` ç«¯ç‚¹
    - ä¾èµ–: T210
    - é¢„è®¡: 1 å°æ—¶

13. **[T212] [P] æ·»åŠ  Redis è®¸å¯è¯ç¼“å­˜**
    - æ–‡ä»¶: `internal/services/license_service.go`
    - å†…å®¹: ç¼“å­˜æœ‰æ•ˆè®¸å¯è¯ï¼ŒTTL 5 åˆ†é’Ÿ
    - ä¾èµ–: T210
    - é¢„è®¡: 1 å°æ—¶

14. **[T213] [P] ç¼–å†™è®¸å¯è¯éªŒè¯æµ‹è¯•**
    - æ–‡ä»¶: `internal/services/license_service_test.go`
    - ä¾èµ–: T210
    - é¢„è®¡: 1.5 å°æ—¶

---

### Phase 9.4: Edge Status Monitoring (P1)

**ç›®æ ‡**: å®ç° Edge çŠ¶æ€ç›‘æ§

**ä»»åŠ¡åˆ—è¡¨**:

15. **[T214] [P] å®ç° Edge Status Tracker**
    - æ–‡ä»¶: `internal/services/edge_status_tracker.go`
    - å†…å®¹: è·Ÿè¸ªè¿æ¥çŠ¶æ€ã€æœ€ååœ¨çº¿æ—¶é—´ã€MQTT çŠ¶æ€
    - é¢„è®¡: 2 å°æ—¶

16. **[T215] [P] å®ç°å‘Šè­¦èšåˆåˆ†æ**
    - æ–‡ä»¶: `internal/services/alert_aggregation_service.go`
    - å†…å®¹: è·¨å‚¨èƒ½æŸœå‘Šè­¦åˆ†æã€ç¾¤ä½“å¼‚å¸¸æ£€æµ‹
    - é¢„è®¡: 3 å°æ—¶

17. **[T216] [P] å®ç° Edge ç®¡ç† API**
    - æ–‡ä»¶: `internal/api/handlers/edge_cabinet.go`
    - å†…å®¹: Edge åˆ—è¡¨ã€çŠ¶æ€æŸ¥è¯¢ã€è¿æ¥ç®¡ç†
    - é¢„è®¡: 2 å°æ—¶

---

### Phase 9.5: Frontend Integration (P1)

**ç›®æ ‡**: å®ç° Edge ç®¡ç†å‰ç«¯é¡µé¢

**ä»»åŠ¡åˆ—è¡¨**:

18. **[T217] [P] åˆ›å»º Edge Cabinet Store**
    - æ–‡ä»¶: `frontend/src/store/edge_cabinet.ts`
    - å†…å®¹: Edge åˆ—è¡¨ã€çŠ¶æ€æŸ¥è¯¢
    - é¢„è®¡: 1 å°æ—¶

19. **[T218] [P] åˆ›å»º Edge ç®¡ç†é¡µé¢**
    - æ–‡ä»¶: `frontend/src/views/EdgeManage.vue`
    - å†…å®¹: Edge åˆ—è¡¨ã€çŠ¶æ€ç›‘æ§ã€æŒ‡ä»¤ä¸‹å‘
    - ä¾èµ–: T217
    - é¢„è®¡: 4 å°æ—¶

20. **[T219] [P] é›†æˆ Edge è·¯ç”±**
    - æ–‡ä»¶: `frontend/src/router/index.ts`
    - å†…å®¹: æ·»åŠ  Edge ç®¡ç†è·¯ç”±
    - ä¾èµ–: T218
    - é¢„è®¡: 0.5 å°æ—¶

---

### Phase 9.6: Testing & Documentation (P0)

**ç›®æ ‡**: å®Œæˆæµ‹è¯•å’Œæ–‡æ¡£

**ä»»åŠ¡åˆ—è¡¨**:

21. **[T220] [P] ç¼–å†™é›†æˆæµ‹è¯•**
    - æ–‡ä»¶: `tests/integration/edge_integration_test.go`
    - å†…å®¹: ç«¯åˆ°ç«¯æµ‹è¯•ï¼ˆEdgeâ†’Cloud æ•°æ®æµ + Cloudâ†’Edge æŒ‡ä»¤æµï¼‰
    - é¢„è®¡: 4 å°æ—¶

22. **[T221] [P] ç¼–å†™æ€§èƒ½æµ‹è¯•**
    - æ–‡ä»¶: `tests/performance/edge_sync_benchmark_test.go`
    - å†…å®¹: æ‰¹é‡åŒæ­¥æ€§èƒ½ã€å¹¶å‘èƒ½åŠ›æµ‹è¯•
    - é¢„è®¡: 3 å°æ—¶

23. **[T222] [P] æ›´æ–° API æ–‡æ¡£**
    - æ–‡ä»¶: `docs/API.md`
    - å†…å®¹: è¡¥å…… Edge ç›¸å…³ API æ–‡æ¡£
    - é¢„è®¡: 2 å°æ—¶

24. **[T223] [P] ç¼–å†™è”è°ƒæŒ‡å—**
    - æ–‡ä»¶: `docs/EDGE_INTEGRATION_GUIDE.md`
    - å†…å®¹: Edge-Cloud è”è°ƒæ­¥éª¤ã€å¸¸è§é—®é¢˜
    - é¢„è®¡: 2 å°æ—¶

---

## ğŸ“Š Task Summary

| Phase | ä»»åŠ¡æ•° | é¢„è®¡å·¥æ—¶ | ä¼˜å…ˆçº§ |
|-------|-------|---------|-------|
| 9.1 Edge Sync | 6 | 10.5h | P0 |
| 9.2 MQTT Adjustment | 4 | 5.5h | P0 |
| 9.3 License Validation | 4 | 4.5h | P0 |
| 9.4 Edge Monitoring | 3 | 7h | P1 |
| 9.5 Frontend | 3 | 5.5h | P1 |
| 9.6 Testing & Docs | 4 | 11h | P0 |
| **æ€»è®¡** | **24** | **44h** | - |

**é¢„è®¡å®Œæˆæ—¶é—´**: 5-6 ä¸ªå·¥ä½œæ—¥ï¼ˆ1 äººå…¨èŒï¼‰

---

## ğŸš€ Quickstart Guide

è¯¦è§ `quickstart.md`

---

## âœ… Definition of Done

- [ ] æ‰€æœ‰ P0 ä»»åŠ¡å®Œæˆï¼ˆT200-T213, T220-T223ï¼‰
- [ ] å•å…ƒæµ‹è¯•è¦†ç›–ç‡ â‰¥ 70%
- [ ] é›†æˆæµ‹è¯•é€šè¿‡
- [ ] æ€§èƒ½æµ‹è¯•è¾¾æ ‡ï¼ˆ1000 æ¡æ•°æ® â‰¤2 ç§’ï¼‰
- [ ] ä»£ç å®¡æŸ¥é€šè¿‡
- [ ] æ–‡æ¡£å®Œæ•´
- [ ] éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒå¹¶éªŒè¯

---

**Next Steps**: å¼€å§‹ Phase 9.1 - Edge Sync Implementation

