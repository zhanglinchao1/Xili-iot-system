# 质量保证检查清单

**项目**: Cloud端储能柜集群管理系统  
**版本**: 1.0.0  
**更新日期**: 2025-11-04

## 目的

本文档定义了项目各阶段必须执行的质量保证检查项，确保代码质量、安全性和可维护性。

## 每个任务完成后的强制检查

### 1. 代码编译检查 ⚠️ **阻塞性**

**后端 (Go)**
```bash
# 编译检查
go build ./...

# 静态分析
go vet ./...

# 格式检查
gofmt -l .

# 依赖检查
go mod tidy
go mod verify
```

**前端 (Vue/TypeScript)**
```bash
# TypeScript编译
npm run build

# 类型检查
vue-tsc --noEmit

# 格式检查
npm run lint
```

**结果要求**: 
- ✅ 无编译错误
- ✅ 无类型错误
- ✅ 无格式警告

---

### 2. 代码逻辑检查

#### 2.1 错误处理
- [ ] 所有错误都被正确处理（不使用 `_` 忽略错误）
- [ ] 错误消息清晰、有上下文
- [ ] 使用统一的错误类型和格式
- [ ] Panic情况都有recover处理

#### 2.2 空指针检查
- [ ] 所有指针在解引用前检查nil
- [ ] 配置对象访问前验证非空
- [ ] 数据库/缓存结果检查存在性

#### 2.3 资源管理
- [ ] 数据库连接正确关闭（defer）
- [ ] 文件句柄正确关闭
- [ ] Goroutine正确退出，无泄漏
- [ ] Context正确传递和取消

#### 2.4 并发安全
- [ ] 共享数据使用mutex保护
- [ ] 避免race condition
- [ ] Channel正确关闭
- [ ] WaitGroup正确使用

---

### 3. 业务逻辑验证

#### 3.1 输入验证
- [ ] 所有用户输入都经过验证
- [ ] 使用白名单而非黑名单
- [ ] 防止SQL注入（使用参数化查询）
- [ ] 防止XSS攻击（输出转义）

#### 3.2 状态转换
- [ ] 状态机转换合法
- [ ] 幂等性处理（必要时）
- [ ] 事务边界正确
- [ ] 乐观锁/悲观锁使用正确

#### 3.3 数据一致性
- [ ] 外键约束正确
- [ ] 级联删除考虑周全
- [ ] 数据版本控制（必要时）
- [ ] 缓存与数据库一致性

---

### 4. 性能检查

#### 4.1 数据库查询
- [ ] 使用索引（explain分析）
- [ ] 避免N+1查询
- [ ] 分页实现正确
- [ ] 批量操作使用事务

#### 4.2 API性能
- [ ] 响应时间 < 500ms（正常情况）
- [ ] 支持并发请求
- [ ] 大数据量分页返回
- [ ] 使用缓存（必要时）

#### 4.3 内存使用
- [ ] 避免内存泄漏
- [ ] 大对象及时释放
- [ ] 流式处理大文件
- [ ] 合理的缓存大小

---

### 5. 安全检查

#### 5.1 认证授权
- [ ] API端点有正确的认证
- [ ] Token验证完整
- [ ] 权限检查到位
- [ ] 敏感操作需要授权

#### 5.2 数据保护
- [ ] 密码正确哈希（bcrypt）
- [ ] 敏感数据不打印到日志
- [ ] API响应不泄露敏感信息
- [ ] HTTPS传输（生产环境）

#### 5.3 注入防护
- [ ] SQL注入防护（参数化）
- [ ] XSS防护（输出转义）
- [ ] CSRF防护（必要时）
- [ ] 命令注入防护

---

### 6. 测试覆盖

#### 6.1 单元测试 (Phase 3+)
- [ ] 核心逻辑测试覆盖率 > 70%
- [ ] 边界条件测试
- [ ] 错误路径测试
- [ ] Mock外部依赖

#### 6.2 集成测试 (Phase 3+)
- [ ] API端点测试
- [ ] 数据库操作测试
- [ ] MQTT消息测试
- [ ] 缓存操作测试

#### 6.3 E2E测试 (Phase 4)
- [ ] 关键业务流程测试
- [ ] 用户场景测试
- [ ] 跨模块交互测试

---

### 7. 代码质量

#### 7.1 可读性
- [ ] 函数不超过50行（复杂逻辑除外）
- [ ] 变量命名清晰
- [ ] 注释清晰（公开API必须注释）
- [ ] 代码格式一致

#### 7.2 可维护性
- [ ] 单一职责原则
- [ ] 避免重复代码（DRY）
- [ ] 合理的抽象层次
- [ ] 易于扩展

#### 7.3 文档
- [ ] API注释完整
- [ ] 复杂逻辑有说明
- [ ] README更新
- [ ] 变更日志记录

---

## Bug修复流程

### 发现Bug时
1. **记录Bug**: 创建Issue，包含复现步骤
2. **优先级评估**: 
   - P0: 阻塞性bug（立即修复）
   - P1: 严重bug（本轮迭代修复）
   - P2: 一般bug（下轮迭代修复）
   - P3: 轻微bug（规划修复）

3. **Root Cause分析**: 找出根本原因
4. **修复实现**: 编写修复代码
5. **测试验证**: 单元测试 + 集成测试
6. **回归测试**: 确保未引入新bug
7. **代码审查**: Peer review
8. **文档更新**: 记录修复内容

### Bug修复检查清单
- [ ] Root cause已明确
- [ ] 修复代码已实现
- [ ] 添加了防止回归的测试
- [ ] 相关文档已更新
- [ ] 代码审查已通过
- [ ] 无新的问题引入

---

## 各阶段质量门禁

### Phase 0: Research & Technology Selection
- ✅ 技术选型有充分理由
- ✅ 依赖版本无冲突
- ✅ 架构设计合理

### Phase 1: Data Models & Contracts
- ✅ 数据模型完整一致
- ✅ API契约符合规范
- ✅ 索引策略合理

### Phase 2: Foundation Implementation
- ✅ 编译无错误
- ✅ 静态分析无警告
- ✅ 代码审查通过
- ✅ 已知bug已修复

### Phase 3: Feature Implementation
每个User Story必须通过：
- [ ] 功能完整实现
- [ ] 单元测试通过（覆盖率>70%）
- [ ] 集成测试通过
- [ ] 代码审查通过
- [ ] 性能指标达标
- [ ] 安全检查通过
- [ ] 无已知P0/P1 bug

### Phase 4: Testing & Deployment
- [ ] E2E测试通过
- [ ] 压力测试通过
- [ ] 安全测试通过
- [ ] 文档完整
- [ ] 部署验证通过

---

## 工具推荐

### 后端 (Go)
- **静态分析**: `go vet`, `golangci-lint`, `staticcheck`
- **测试**: `go test`, `testify`, `httptest`
- **覆盖率**: `go test -cover`, `gocov`
- **性能**: `pprof`, `benchstat`
- **依赖**: `go mod`, `govulncheck`

### 前端 (Vue/TypeScript)
- **静态分析**: `ESLint`, `vue-tsc`
- **测试**: `Vitest`, `Vue Test Utils`
- **覆盖率**: `c8`, `istanbul`
- **E2E**: `Playwright`, `Cypress`
- **性能**: `Lighthouse`, `WebPageTest`

### 通用
- **代码审查**: GitHub Pull Request
- **CI/CD**: GitHub Actions, GitLab CI
- **安全扫描**: `Snyk`, `Dependabot`, `OWASP ZAP`
- **监控**: `Prometheus`, `Grafana`, `ELK`

---

## 检查清单使用说明

### 开发阶段
1. 开发前：审查需求和设计
2. 开发中：遵循编码规范
3. 开发后：执行自检清单

### 代码提交前
- [ ] 运行所有自动化检查
- [ ] 执行相关测试
- [ ] 更新文档
- [ ] 自我代码审查

### Pull Request
- [ ] 填写PR描述
- [ ] 关联相关Issue
- [ ] 请求代码审查
- [ ] 通过CI检查

---

**维护者**: 开发团队  
**审批者**: Tech Lead  
**下次审查**: 每个Phase完成后

