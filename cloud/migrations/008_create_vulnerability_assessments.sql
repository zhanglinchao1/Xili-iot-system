-- 创建脆弱性评估表
CREATE TABLE IF NOT EXISTS vulnerability_assessments (
    id BIGSERIAL PRIMARY KEY,
    cabinet_id VARCHAR(64) NOT NULL,
    timestamp TIMESTAMPTZ NOT NULL DEFAULT NOW(),

    -- 四维度评分 (0-100)
    license_compliance_score DOUBLE PRECISION NOT NULL DEFAULT 100,
    communication_score DOUBLE PRECISION NOT NULL,
    config_security_score DOUBLE PRECISION NOT NULL,
    data_anomaly_score DOUBLE PRECISION NOT NULL,

    -- 综合评分
    overall_score DOUBLE PRECISION NOT NULL,
    risk_level VARCHAR(16) NOT NULL,  -- healthy/low/medium/high/critical

    -- 传输指标 (JSON格式)
    transmission_metrics JSONB,

    -- 流量特征 (JSON数组)
    traffic_features JSONB,

    -- 配置检查结果 (JSON对象)
    config_checks JSONB,

    -- 检测到的漏洞 (JSON数组)
    detected_vulnerabilities JSONB,

    -- 同步状态
    synced_from_edge BOOLEAN DEFAULT TRUE,
    received_at TIMESTAMPTZ DEFAULT NOW(),

    -- 外键约束
    CONSTRAINT fk_cabinet FOREIGN KEY (cabinet_id) REFERENCES cabinets(cabinet_id) ON DELETE CASCADE
);

-- 创建索引
CREATE INDEX IF NOT EXISTS idx_va_cabinet_id ON vulnerability_assessments(cabinet_id);
CREATE INDEX IF NOT EXISTS idx_va_timestamp ON vulnerability_assessments(timestamp DESC);
CREATE INDEX IF NOT EXISTS idx_va_risk_level ON vulnerability_assessments(risk_level);
CREATE INDEX IF NOT EXISTS idx_va_cabinet_timestamp ON vulnerability_assessments(cabinet_id, timestamp DESC);

-- 创建TimescaleDB超表 (如果启用了TimescaleDB)
SELECT create_hypertable('vulnerability_assessments', 'timestamp',
    if_not_exists => TRUE,
    chunk_time_interval => INTERVAL '7 days'
);

-- 添加表注释
COMMENT ON TABLE vulnerability_assessments IS '储能柜脆弱性评估结果';
COMMENT ON COLUMN vulnerability_assessments.license_compliance_score IS '许可证合规性评分 (权重30%)';
COMMENT ON COLUMN vulnerability_assessments.communication_score IS '通信异常评分 (权重25%)';
COMMENT ON COLUMN vulnerability_assessments.config_security_score IS '配置安全评分 (权重20%)';
COMMENT ON COLUMN vulnerability_assessments.data_anomaly_score IS '数据异常评分 (权重25%)';
COMMENT ON COLUMN vulnerability_assessments.overall_score IS '综合评分 (0-100)';
COMMENT ON COLUMN vulnerability_assessments.risk_level IS '风险等级';

-- 创建漏洞事件表 (用于详细记录每个漏洞)
CREATE TABLE IF NOT EXISTS vulnerability_events (
    id BIGSERIAL PRIMARY KEY,
    assessment_id BIGINT NOT NULL,
    cabinet_id VARCHAR(64) NOT NULL,

    -- 漏洞信息
    event_type VARCHAR(64) NOT NULL,
    category VARCHAR(32) NOT NULL,  -- network/config/data/license
    title VARCHAR(255) NOT NULL,
    severity VARCHAR(16) NOT NULL,  -- low/medium/high/critical
    description TEXT NOT NULL,
    solution TEXT,

    detected_at TIMESTAMPTZ NOT NULL,
    created_at TIMESTAMPTZ DEFAULT NOW(),

    -- 外键约束
    CONSTRAINT fk_assessment FOREIGN KEY (assessment_id) REFERENCES vulnerability_assessments(id) ON DELETE CASCADE,
    CONSTRAINT fk_cabinet_event FOREIGN KEY (cabinet_id) REFERENCES cabinets(cabinet_id) ON DELETE CASCADE
);

-- 创建事件索引
CREATE INDEX IF NOT EXISTS idx_ve_assessment_id ON vulnerability_events(assessment_id);
CREATE INDEX IF NOT EXISTS idx_ve_cabinet_id ON vulnerability_events(cabinet_id);
CREATE INDEX IF NOT EXISTS idx_ve_severity ON vulnerability_events(severity);
CREATE INDEX IF NOT EXISTS idx_ve_category ON vulnerability_events(category);
CREATE INDEX IF NOT EXISTS idx_ve_detected_at ON vulnerability_events(detected_at DESC);

-- 添加事件表注释
COMMENT ON TABLE vulnerability_events IS '脆弱性事件详细记录';
COMMENT ON COLUMN vulnerability_events.category IS '漏洞分类: network(网络)/config(配置)/data(数据)/license(许可证)';
COMMENT ON COLUMN vulnerability_events.severity IS '严重程度: low/medium/high/critical';
