/*
 * 许可证合规性评分器
 * 评估许可证有效性、设备数量限制等
 */
package vulnerability

import (
	"time"

	"github.com/edge/storage-cabinet/internal/license"
	"go.uber.org/zap"
)

// LicenseScorer 许可证评分器
type LicenseScorer struct {
	logger         *zap.Logger
	licenseService *license.Service
}

// NewLicenseScorer 创建许可证评分器
func NewLicenseScorer(licenseService *license.Service, logger *zap.Logger) *LicenseScorer {
	return &LicenseScorer{
		logger:         logger,
		licenseService: licenseService,
	}
}

// CalculateScore 计算许可证合规性评分 (0-100)
func (s *LicenseScorer) CalculateScore() float64 {
	// 如果许可证系统未启用，返回满分
	if !s.licenseService.IsEnabled() {
		s.logger.Debug("许可证系统未启用，返回满分")
		return 100.0
	}

	// 获取许可证信息
	licenseInfoMap := s.licenseService.GetLicenseInfo()
	if licenseInfoMap == nil || !licenseInfoMap["enabled"].(bool) {
		s.logger.Warn("无法获取许可证信息")
		return 0.0
	}

	var score float64 = 100.0

	// 1. 检查许可证有效性 (40%)
	validityScore := s.checkValidity(licenseInfoMap)
	score = score * 0.4 * validityScore / 100

	// 2. 检查有效期 (35%)
	expiryScore := s.checkExpiry(licenseInfoMap)
	score += 100 * 0.35 * expiryScore / 100

	// 3. 检查设备数量限制 (25%)
	deviceScore := s.checkDeviceLimit(s.licenseService.GetMaxDevices())
	score += 100 * 0.25 * deviceScore / 100

	s.logger.Debug("许可证合规性评分",
		zap.Float64("validity_score", validityScore),
		zap.Float64("expiry_score", expiryScore),
		zap.Float64("device_score", deviceScore),
		zap.Float64("total_score", score),
	)

	return score
}

// checkValidity 检查许可证有效性
func (s *LicenseScorer) checkValidity(info map[string]interface{}) float64 {
	// 检查是否已过期且不在宽限期内
	isExpired, _ := info["is_expired"].(bool)
	inGracePeriod, _ := info["in_grace_period"].(bool)

	if isExpired && !inGracePeriod {
		s.logger.Warn("许可证已过期且超过宽限期")
		return 0.0
	}
	return 100.0
}

// checkExpiry 检查许可证有效期
func (s *LicenseScorer) checkExpiry(info map[string]interface{}) float64 {
	expiresAtStr, ok := info["expires_at"].(string)
	if !ok {
		s.logger.Warn("无法获取许可证过期时间")
		return 50.0 // 无法判断，给中等分数
	}

	expireTime, err := time.Parse(time.RFC3339, expiresAtStr)
	if err != nil {
		s.logger.Warn("解析许可证过期时间失败", zap.Error(err))
		return 50.0
	}

	now := time.Now()
	isExpired, _ := info["is_expired"].(bool)
	inGracePeriod, _ := info["in_grace_period"].(bool)

	// 如果已过期
	if isExpired {
		daysOverdue := int(now.Sub(expireTime).Hours() / 24)

		// 在宽限期内
		if inGracePeriod {
			// 线性衰减：从100分降到50分（假设宽限期3天）
			score := 100.0 - (float64(daysOverdue) / 3.0 * 50.0)
			if score < 50.0 {
				score = 50.0
			}
			s.logger.Warn("许可证已过期，在宽限期内",
				zap.Int("days_overdue", daysOverdue),
				zap.Float64("score", score),
			)
			return score
		}

		// 超过宽限期
		s.logger.Error("许可证已过期且超过宽限期",
			zap.Int("days_overdue", daysOverdue),
		)
		return 0.0
	}

	// 计算剩余天数
	daysRemaining := int(expireTime.Sub(now).Hours() / 24)

	// 如果剩余时间 > 30天，满分
	if daysRemaining > 30 {
		return 100.0
	}

	// 如果剩余 7-30天，90-100分线性衰减
	if daysRemaining >= 7 {
		score := 90.0 + (float64(daysRemaining-7) / 23.0 * 10.0)
		s.logger.Info("许可证即将过期",
			zap.Int("days_remaining", daysRemaining),
			zap.Float64("score", score),
		)
		return score
	}

	// 如果剩余 0-7天，50-90分线性衰减
	score := 50.0 + (float64(daysRemaining) / 7.0 * 40.0)
	s.logger.Warn("许可证即将过期（7天内）",
		zap.Int("days_remaining", daysRemaining),
		zap.Float64("score", score),
	)
	return score
}

// checkDeviceLimit 检查设备数量限制
func (s *LicenseScorer) checkDeviceLimit(maxDevices int) float64 {
	// TODO: 获取当前实际设备数量
	// 从设备管理器获取在线设备数量
	// currentDevices := s.deviceManager.GetActiveDeviceCount()
	currentDevices := 0 // 暂时使用0

	// 如果没有设备数量限制，返回满分
	if maxDevices <= 0 {
		return 100.0
	}

	// 计算使用率
	usageRate := float64(currentDevices) / float64(maxDevices)

	// 使用率 < 70%：满分
	if usageRate < 0.7 {
		return 100.0
	}

	// 使用率 70-90%：90-100分线性衰减
	if usageRate < 0.9 {
		score := 90.0 + ((0.9 - usageRate) / 0.2 * 10.0)
		s.logger.Info("设备数量接近限制",
			zap.Int("current", currentDevices),
			zap.Int("max", maxDevices),
			zap.Float64("usage_rate", usageRate),
			zap.Float64("score", score),
		)
		return score
	}

	// 使用率 90-100%：50-90分线性衰减
	if usageRate < 1.0 {
		score := 50.0 + ((1.0 - usageRate) / 0.1 * 40.0)
		s.logger.Warn("设备数量接近限制",
			zap.Int("current", currentDevices),
			zap.Int("max", maxDevices),
			zap.Float64("usage_rate", usageRate),
			zap.Float64("score", score),
		)
		return score
	}

	// 超过限制：0分
	s.logger.Error("设备数量超过许可证限制",
		zap.Int("current", currentDevices),
		zap.Int("max", maxDevices),
	)
	return 0.0
}
