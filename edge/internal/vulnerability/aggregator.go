/*
 * 评分聚合与变化监控模块
 * 负责聚合各维度评分并计算综合评分
 */
package vulnerability

import (
	"time"

	"github.com/edge/storage-cabinet/pkg/models"
	"go.uber.org/zap"
)

// Aggregator 评分聚合器
type Aggregator struct {
	logger *zap.Logger
	config VulnerabilityConfig
}

// NewAggregator 创建评分聚合器
func NewAggregator(cfg VulnerabilityConfig, logger *zap.Logger) *Aggregator {
	return &Aggregator{
		logger: logger,
		config: cfg,
	}
}

// AggregateScores 聚合评分 (四维度)
func (a *Aggregator) AggregateScores(
	cabinetID string,
	licenseScore float64, // 新增: 许可证合规性评分
	commScore float64,
	configScore float64,
	dataScore float64,
	metrics *models.TransmissionMetrics,
	vulnerabilities []models.VulnerabilityEvent,
	configChecks map[string]bool,
) *models.EdgeVulnerabilityReport {
	// 1. 计算加权综合评分 (四维度权重: 30%, 25%, 20%, 25%)
	weightLicense := 0.30 // 许可证合规性
	weightComm := 0.25    // 通信异常
	weightConfig := 0.20  // 配置安全
	weightData := 0.25    // 数据异常

	// 从配置读取权重(如果存在)
	if a.config.Weights.Communication > 0 {
		weightComm = a.config.Weights.Communication
	}
	if a.config.Weights.ConfigSecurity > 0 {
		weightConfig = a.config.Weights.ConfigSecurity
	}
	if a.config.Weights.DataAnomaly > 0 {
		weightData = a.config.Weights.DataAnomaly
	}

	// 归一化权重
	totalWeight := weightLicense + weightComm + weightConfig + weightData
	weightLicense /= totalWeight
	weightComm /= totalWeight
	weightConfig /= totalWeight
	weightData /= totalWeight

	overallScore := weightLicense*licenseScore + weightComm*commScore + weightConfig*configScore + weightData*dataScore

	// 2. 根据漏洞严重程度调整评分
	for _, vuln := range vulnerabilities {
		penalty := a.getVulnerabilityPenalty(vuln.Severity)
		overallScore -= penalty
	}

	// 确保评分在0-100范围内
	if overallScore < 0 {
		overallScore = 0
	}
	if overallScore > 100 {
		overallScore = 100
	}

	// 3. 确定风险等级
	riskLevel := a.determineRiskLevel(overallScore)

	// 4. 构建评估报告（configChecks已从参数传入）
	report := &models.EdgeVulnerabilityReport{
		CabinetID:               cabinetID,
		Timestamp:               time.Now(),
		LicenseComplianceScore:  licenseScore, // 新增
		CommunicationScore:      commScore,
		ConfigSecurityScore:     configScore,
		DataAnomalyScore:        dataScore,
		OverallScore:            overallScore,
		RiskLevel:               riskLevel,
		TransmissionMetrics:     metrics,
		TrafficFeatures:         []float64{}, // 暂时为空
		ConfigChecks:            configChecks,
		DetectedVulnerabilities: vulnerabilities,
	}

	a.logger.Debug("评分聚合完成(四维度)",
		zap.Float64("license_score", licenseScore),
		zap.Float64("comm_score", commScore),
		zap.Float64("config_score", configScore),
		zap.Float64("data_score", dataScore),
		zap.Float64("overall_score", overallScore),
		zap.String("risk_level", riskLevel),
	)

	return report
}

// determineRiskLevel 确定风险等级
// healthy: 90-100分 (健康环境)
// low: 75-89分 (低风险)
// medium: 60-74分 (中等风险)
// high: 40-59分 (高风险)
// critical: 0-39分 (严重风险)
func (a *Aggregator) determineRiskLevel(score float64) string {
	if score >= 90 {
		return "healthy"  // 新增：健康环境
	} else if score >= 75 {
		return "low"      // 调整：90→75
	} else if score >= 60 {
		return "medium"   // 调整：70→60
	} else if score >= 40 {
		return "high"     // 调整：50→40
	}
	return "critical"
}

// getVulnerabilityPenalty 根据漏洞严重程度获取扣分
func (a *Aggregator) getVulnerabilityPenalty(severity string) float64 {
	switch severity {
	case "critical":
		return 15.0  // 降低：20 → 15
	case "high":
		return 10.0  // 降低：15 → 10
	case "medium":
		return 5.0   // 降低：10 → 5
	case "low":
		return 2.0   // 降低：5 → 2
	default:
		return 0.0
	}
}

// CalculateScoreChange 计算评分变化
func (a *Aggregator) CalculateScoreChange(oldReport, newReport *models.EdgeVulnerabilityReport) float64 {
	if oldReport == nil || newReport == nil {
		return 0
	}

	change := newReport.OverallScore - oldReport.OverallScore
	if change < 0 {
		change = -change // 返回绝对值
	}

	return change
}

// IsRiskLevelChanged 判断风险等级是否变化
func (a *Aggregator) IsRiskLevelChanged(oldReport, newReport *models.EdgeVulnerabilityReport) bool {
	if oldReport == nil || newReport == nil {
		return false
	}

	return oldReport.RiskLevel != newReport.RiskLevel
}

// ShouldReportToCloud 判断是否应该上报到Cloud
func (a *Aggregator) ShouldReportToCloud(oldReport, newReport *models.EdgeVulnerabilityReport) bool {
	if oldReport == nil {
		return true // 首次评估，需要上报
	}

	// 检查评分变化
	scoreChange := a.CalculateScoreChange(oldReport, newReport)
	if scoreChange >= a.config.ScoreChangeThreshold {
		return true
	}

	// 检查风险等级变化
	if a.IsRiskLevelChanged(oldReport, newReport) {
		return true
	}

	// 检查是否有新的严重漏洞
	if a.hasNewCriticalVulnerability(oldReport, newReport) {
		return true
	}

	return false
}

// hasNewCriticalVulnerability 检查是否有新的严重漏洞
func (a *Aggregator) hasNewCriticalVulnerability(oldReport, newReport *models.EdgeVulnerabilityReport) bool {
	// 统计新报告中critical和high级别的漏洞数量
	newCriticalCount := 0
	for _, vuln := range newReport.DetectedVulnerabilities {
		if vuln.Severity == "critical" || vuln.Severity == "high" {
			newCriticalCount++
		}
	}

	// 统计旧报告中critical和high级别的漏洞数量
	oldCriticalCount := 0
	for _, vuln := range oldReport.DetectedVulnerabilities {
		if vuln.Severity == "critical" || vuln.Severity == "high" {
			oldCriticalCount++
		}
	}

	// 如果新的严重漏洞增加了，返回true
	return newCriticalCount > oldCriticalCount
}
