/*
 * 脆弱性评估数据模型
 * 定义Edge端脆弱性评估相关的数据结构
 */
package models

import "time"

// EdgeVulnerabilityReport Edge端上报的评估结果
type EdgeVulnerabilityReport struct {
	ID        int64     `json:"id,omitempty"`   // 数据库ID(保存后填充)
	CabinetID string    `json:"cabinet_id"`
	Timestamp time.Time `json:"timestamp"`

	// Edge端计算的评分（0-100）- 四维度
	LicenseComplianceScore float64 `json:"license_compliance_score"` // 许可证合规性评分 (新增)
	CommunicationScore     float64 `json:"communication_score"`      // 通信异常评分
	ConfigSecurityScore    float64 `json:"config_security_score"`    // 配置安全评分
	DataAnomalyScore       float64 `json:"data_anomaly_score"`       // 数据异常评分

	// 综合评分
	OverallScore float64 `json:"overall_score"` // 综合评分
	RiskLevel    string  `json:"risk_level"`    // 风险等级: healthy/low/medium/high/critical

	// 原始数据（用于Cloud端深度分析）
	TransmissionMetrics     *TransmissionMetrics `json:"transmission_metrics"`
	TrafficFeatures         []float64            `json:"traffic_features,omitempty"`
	ConfigChecks            map[string]bool      `json:"config_checks"`
	DetectedVulnerabilities []VulnerabilityEvent `json:"detected_vulnerabilities"`
}

// TransmissionMetrics 传输指标
type TransmissionMetrics struct {
	LatencyAvg        float64 `json:"latency_avg"`        // 平均延迟(ms)
	PacketLossRate    float64 `json:"packet_loss_rate"`   // 丢包率(0-1)
	Throughput        float64 `json:"throughput"`         // 吞吐量(Kbps)
	MQTTSuccessRate   float64 `json:"mqtt_success_rate"`  // MQTT发送成功率(0-1)
	ReconnectionCount int     `json:"reconnection_count"` // 重连次数
}

// VulnerabilityEvent 漏洞事件
type VulnerabilityEvent struct {
	Type        string    `json:"type"`        // 漏洞类型
	Category    string    `json:"category"`    // 漏洞分类: network/config/data/license
	Title       string    `json:"title"`       // 漏洞标题
	Severity    string    `json:"severity"`    // 严重程度: low/medium/high/critical
	Description string    `json:"description"` // 描述
	Solution    string    `json:"solution"`    // 解决方案
	DetectedAt  time.Time `json:"detected_at"` // 检测时间
}

// VulnerabilityAssessment 脆弱性评估结果（数据库模型）
type VulnerabilityAssessment struct {
	ID                      int64      `json:"id" db:"id"`
	CabinetID               string     `json:"cabinet_id" db:"cabinet_id"`
	Timestamp               time.Time  `json:"timestamp" db:"timestamp"`
	LicenseComplianceScore  float64    `json:"license_compliance_score" db:"license_compliance_score"` // 新增
	CommunicationScore      float64    `json:"communication_score" db:"communication_score"`
	ConfigSecurityScore     float64    `json:"config_security_score" db:"config_security_score"`
	DataAnomalyScore        float64    `json:"data_anomaly_score" db:"data_anomaly_score"`
	OverallScore            float64    `json:"overall_score" db:"overall_score"`
	RiskLevel               string     `json:"risk_level" db:"risk_level"`
	TransmissionMetricsJSON string     `json:"-" db:"transmission_metrics"`     // JSON字符串
	TrafficFeaturesJSON     string     `json:"-" db:"traffic_features"`         // JSON字符串
	ConfigChecksJSON        string     `json:"-" db:"config_checks"`            // JSON字符串
	DetectedVulnJSON        string     `json:"-" db:"detected_vulnerabilities"` // JSON字符串
	Synced                  bool       `json:"synced" db:"synced"`
	SyncedAt                *time.Time `json:"synced_at,omitempty" db:"synced_at"`
}

// TransmissionMetricsRecord 传输指标记录（数据库模型）
type TransmissionMetricsRecord struct {
	ID                int64     `json:"id" db:"id"`
	CabinetID         string    `json:"cabinet_id" db:"cabinet_id"`
	Timestamp         time.Time `json:"timestamp" db:"timestamp"`
	LatencyAvg        float64   `json:"latency_avg" db:"latency_avg"`
	PacketLossRate    float64   `json:"packet_loss_rate" db:"packet_loss_rate"`
	Throughput        float64   `json:"throughput" db:"throughput"`
	MQTTSuccessRate   float64   `json:"mqtt_success_rate" db:"mqtt_success_rate"`
	ReconnectionCount int       `json:"reconnection_count" db:"reconnection_count"`
}

// VulnerabilityHistoryRequest 历史查询请求
type VulnerabilityHistoryRequest struct {
	CabinetID string    `form:"cabinet_id" json:"cabinet_id"`
	StartTime time.Time `form:"start_time" json:"start_time"`
	EndTime   time.Time `form:"end_time" json:"end_time"`
	Limit     int       `form:"limit" json:"limit"`
}

// VulnerabilityHistoryResponse 历史查询响应
type VulnerabilityHistoryResponse struct {
	Assessments []VulnerabilityAssessment `json:"assessments"`
	Total       int64                     `json:"total"`
}
