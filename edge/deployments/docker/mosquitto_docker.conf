# Mosquitto TLS 配置文件 - Docker 环境
# Edge System - MQTT Broker with TLS Support

# 非加密监听（用于本地orangepi-gateway连接和容器内测试）
listener 1883 0.0.0.0
protocol mqtt
allow_anonymous true

# TLS加密监听（用于外部客户端）
listener 8883 0.0.0.0
protocol mqtt

# TLS证书配置（Docker容器内路径）
cafile /app/configs/certs/ca.crt
certfile /app/configs/certs/server.crt
keyfile /app/configs/certs/server.key

# TLS版本设置（仅允许TLS 1.2及以上）
tls_version tlsv1.2

# 客户端证书要求（测试阶段设置为false）
require_certificate false
use_identity_as_username false

# 允许匿名连接（测试环境）
allow_anonymous true

# 日志配置
log_type all
log_dest file /app/logs/mosquitto/mosquitto_tls.log
log_dest stdout
log_timestamp true

# 持久化配置
persistence true
persistence_location /app/logs/mosquitto/data

# 连接设置
max_connections -1
max_keepalive 300

# 消息队列设置
max_queued_messages 1000

# ============================================================
# MQTT 桥接配置 - 连接到云端 MQTT Broker（本地环境）
# ============================================================
# 桥接名称
connection bridge-to-cloud

# 云端 MQTT Broker 地址（本地Docker环境使用11883端口，非TLS）
address 127.0.0.1:11883

# 桥接客户端ID
remote_clientid edge-bridge-client

# 云端认证信息（本地环境允许匿名）
# remote_username edge-server
# remote_password edge-server-password

# 不使用TLS（本地环境容器间通信）
# bridge_cafile /app/configs/certs/ca.crt
# bridge_insecure true

# 保持连接
keepalive_interval 60
restart_timeout 30
try_private false

# ============================================================
# 主题映射配置（双向桥接）
# ============================================================

# 1. 上传传感器数据到云端 (本地 → 云端)
topic sensors/# out 1
topic devices/+/status out 1
topic devices/+/heartbeat out 1
topic alerts/# out 1

# 2. 接收云端指令 (云端 → 本地)
topic commands/# in 1
topic control/# in 1
topic config/# in 1

# 桥接启动选项
start_type automatic
notifications true
cleansession false

