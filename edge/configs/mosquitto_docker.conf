# =============================================================================
# Edge端 MQTT Broker 配置文件 (Broker #1 - Docker容器版本) - 仅TLS
# =============================================================================
# 功能:
#   1. 接收orangepi网关的传感器数据 (TLS 8883端口)
#   2. 供Edge服务端订阅传感器数据
#   3. 桥接数据到Cloud端 (TLS 8884端口)
#
# 端口分配 (仅TLS加密):
#   - Edge端 (Broker #1): TLS 8883
#   - Cloud端 (Broker #2): TLS 8884
# =============================================================================

# ============================================================
# TLS加密监听端口 (仅TLS，无明文端口)
# ============================================================
listener 8883 0.0.0.0
protocol mqtt

# TLS证书配置 (Docker容器内路径)
cafile /mosquitto/certs/ca.crt
certfile /mosquitto/certs/server.crt
keyfile /mosquitto/certs/server.key

# TLS版本设置（仅允许TLS 1.2及以上）
tls_version tlsv1.2

# 客户端证书要求（测试阶段设置为false）
require_certificate false
use_identity_as_username false

# 允许匿名连接（测试环境）
allow_anonymous true

# ============================================================
# 日志配置
# ============================================================
log_type all
log_dest file /mosquitto/log/mosquitto.log
log_dest stdout
log_timestamp true

# ============================================================
# 持久化配置
# ============================================================
persistence true
persistence_location /mosquitto/data/

# ============================================================
# 连接设置
# ============================================================
max_connections -1
max_keepalive 300
max_queued_messages 1000

# ============================================================
# MQTT 桥接配置 - TLS连接到云端 MQTT Broker (Broker #2)
# ============================================================
# 生产环境: 修改CLOUD_IP为Cloud服务器的实际IP
# 开发环境: 使用Docker网关IP (172.18.0.1)
connection bridge-to-cloud

# 云端 MQTT Broker 地址 (TLS端口)
# 使用公网IP连接到云端MQTT Broker
# Cloud服务器地址: 150.158.102.52:8884
address 150.158.102.52:8884

# 桥接客户端ID
remote_clientid edge-bridge-client

# 云端认证信息
remote_username edge-server
remote_password edge-server-password

# TLS配置 (桥接使用TLS连接Cloud)
# 使用 Cloud CA 证书验证 Cloud MQTT broker
bridge_cafile /mosquitto/certs/ca_cloud.crt
# 跳过 hostname 验证（Cloud 证书 CN 是 localhost，但实际连接 IP 地址）
bridge_insecure true

# 保持连接
keepalive_interval 60
restart_timeout 30
try_private false

# ============================================================
# 主题映射配置（双向桥接）
# ============================================================

# 上传传感器数据到云端 (本地 → 云端)
topic sensors/# out 1
topic edge/sensor/# out 1
topic devices/+/status out 1
topic devices/+/heartbeat out 1
topic alerts/# out 1
topic edge/cabinet/+/alerts out 1

# 上传流量数据到云端
topic traffic/# out 1

# 上传ABAC访问日志到云端
topic edge/cabinet/+/abac/logs out 1

# 上传策略分发确认到云端
topic edge/cabinet/+/policy/ack out 1

# 上传命令响应回执到云端 (重要: 解决命令回执失败问题)
topic cloud/cabinets/+/responses/+ out 1

# 接收云端指令 (云端 → 本地)
topic commands/# in 1
topic control/# in 1
topic config/# in 1
topic cloud/cabinet/+/policy/# in 1
topic cloud/cabinets/+/commands/# in 1

# 桥接启动选项
start_type automatic
notifications true
cleansession false
