# Mosquitto TLS 配置文件 - 容器版本
# Edge System - MQTT Broker with TLS Support
# Edge现已仅监听TLS端口8883，1883明文端口已停用

# TLS加密监听
listener 8883 0.0.0.0
protocol mqtt

# TLS证书配置（使用容器内路径）
cafile /app/configs/certs/ca.crt
certfile /app/configs/certs/server.crt
keyfile /app/configs/certs/server.key

# TLS版本设置（仅允许TLS 1.2及以上）
tls_version tlsv1.2

# 客户端证书要求（测试阶段设置为false）
# 生产环境建议设置为true并要求客户端提供证书
require_certificate false
use_identity_as_username false

# 允许匿名连接（测试环境）
# 生产环境建议禁用并配置密码文件或认证插件
allow_anonymous true

# 日志配置
log_type all
log_dest file /app/logs/mosquitto/mosquitto_tls.log
log_dest stdout
log_timestamp true

# 持久化配置
persistence true
persistence_location /app/logs/mosquitto/data

# 连接设置
max_connections -1
max_keepalive 300

# 消息队列设置
max_queued_messages 1000

# 密码文件（可选，生产环境使用）
# password_file /etc/mosquitto/passwd

# ACL访问控制（可选，生产环境使用）
# acl_file /etc/mosquitto/acl.conf

# ============================================================
# MQTT 桥接配置 - 连接到云端 MQTT Broker
# ============================================================
# 桥接名称
connection bridge-to-cloud

# 云端 MQTT Broker 地址（本地环境）
address 127.0.0.1:18883

# 桥接客户端ID
remote_clientid edge-bridge-client

# 云端认证信息
remote_username edge-server
remote_password edge-server-password

# 启用TLS连接到云端
bridge_cafile /app/configs/certs/ca.crt
bridge_insecure true

# 保持连接
keepalive_interval 60
restart_timeout 30
try_private false

# ============================================================
# 主题映射配置（双向桥接）
# ============================================================

# 1. 上传传感器数据到云端 (本地 → 云端)
# out: 本地发布的消息转发到云端
# QoS 1: 至少一次送达
topic sensors/# out 1
topic devices/+/status out 1
topic devices/+/heartbeat out 1
topic alerts/# out 1

# 2. 接收云端指令 (云端 → 本地)
# in: 云端发布的消息转发到本地
# QoS 1: 至少一次送达
topic commands/# in 1
topic control/# in 1
topic config/# in 1

# 桥接启动选项
start_type automatic
notifications true
cleansession false
