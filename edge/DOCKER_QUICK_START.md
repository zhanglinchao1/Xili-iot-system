# Edge ç³»ç»Ÿ Docker å¿«é€Ÿä¸Šæ‰‹

## ğŸ¯ æ ¸å¿ƒæ¦‚å¿µ

**Go ç¨‹åºå®¹å™¨åŒ–ä¸éœ€è¦æºç ï¼**

- âœ… Go ç¼–è¯‘åæ˜¯**ç‹¬ç«‹çš„äºŒè¿›åˆ¶æ–‡ä»¶**
- âœ… Docker é•œåƒåªåŒ…å«äºŒè¿›åˆ¶ + é…ç½®
- âœ… **æºç å®Œå…¨ä¸ä¼šæš´éœ²**
- âœ… é•œåƒå¤§å°çº¦ 50-80MBï¼ˆåŸºäº Alpineï¼‰

---

## ğŸš€ ä¸€é”®æ„å»ºå’Œéƒ¨ç½²

### æ„å»ºé•œåƒ

```bash
cd /home/zhang/XiLi/Edge
./deployments/docker/build.sh
```

### å¯åŠ¨æœåŠ¡

```bash
cd deployments/docker
docker-compose up -d
```

### æŸ¥çœ‹çŠ¶æ€

```bash
docker-compose ps
docker-compose logs -f
```

---

## ğŸ“¦ äº¤ä»˜ç»™å®¢æˆ·

### å¯¼å‡ºé•œåƒ

```bash
docker save -o edge-system.tar edge-system:latest
```

### æ‰“åŒ…é…ç½®

```bash
tar czf edge-deploy.tar.gz \
    edge-system.tar \
    deployments/docker/docker-compose.yml \
    configs/ \
    auth_verifying.key
```

### å®¢æˆ·ç«¯éƒ¨ç½²

```bash
# 1. è§£å‹
tar xzf edge-deploy.tar.gz

# 2. å¯¼å…¥é•œåƒ
docker load -i edge-system.tar

# 3. åˆ›å»ºæ•°æ®ç›®å½•
mkdir -p data logs

# 4. å¯åŠ¨
cd deployments/docker
docker-compose up -d
```

---

## ğŸ“ æ–‡ä»¶ç»“æ„

```
éƒ¨ç½²åŒ…å†…å®¹ï¼ˆæ— æºç ï¼‰ï¼š
â”œâ”€â”€ edge-system.tar              # Docker é•œåƒï¼ˆäºŒè¿›åˆ¶ï¼‰
â”œâ”€â”€ docker-compose.yml           # å®¹å™¨ç¼–æ’é…ç½®
â”œâ”€â”€ configs/
â”‚   â”œâ”€â”€ config.yaml              # Edge é…ç½®
â”‚   â”œâ”€â”€ mosquitto_tls.conf       # MQTT é…ç½®
â”‚   â””â”€â”€ certs/                   # è¯ä¹¦
â””â”€â”€ auth_verifying.key           # ZKP å¯†é’¥
```

---

## ğŸ” å®¹å™¨åŒ–åŸç†

### Dockerfile å…³é”®éƒ¨åˆ†

```dockerfile
# 1. ä½¿ç”¨è½»é‡çº§åŸºç¡€é•œåƒ
FROM alpine:3.19

# 2. åªå¤åˆ¶ç¼–è¯‘å¥½çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼ˆæ— æºç ï¼‰
COPY edge /app/edge

# 3. å¤åˆ¶é…ç½®æ–‡ä»¶
COPY configs/config.yaml /app/configs/

# 4. è¿è¡ŒäºŒè¿›åˆ¶æ–‡ä»¶
CMD ["/app/edge", "-config", "/app/configs/config.yaml"]
```

### ä¸ºä»€ä¹ˆä¸éœ€è¦æºç ï¼Ÿ

Go è¯­è¨€ç¼–è¯‘ç‰¹ç‚¹ï¼š
- **é™æ€é“¾æ¥**ï¼šæ‰€æœ‰ä¾èµ–éƒ½æ‰“åŒ…åˆ°äºŒè¿›åˆ¶æ–‡ä»¶ä¸­
- **å•æ–‡ä»¶éƒ¨ç½²**ï¼šä¸éœ€è¦è¿è¡Œæ—¶ç¯å¢ƒ
- **è·¨å¹³å°ç¼–è¯‘**ï¼šå¯åœ¨ä»»æ„å¹³å°ç¼–è¯‘ Linux äºŒè¿›åˆ¶

ç¤ºä¾‹ï¼š
```bash
# åœ¨ macOS/Windows ä¸Šç¼–è¯‘ Linux äºŒè¿›åˆ¶
GOOS=linux GOARCH=amd64 go build -o edge cmd/edge/main.go

# è¿™ä¸ª edge æ–‡ä»¶å¯ä»¥ç›´æ¥åœ¨ Linux ä¸Šè¿è¡Œ
# å®Œå…¨ä¸éœ€è¦ Go ç¯å¢ƒå’Œæºä»£ç ï¼
```

---

## ğŸ›¡ï¸ å®‰å…¨æ€§ä¿è¯

### é•œåƒä¸­ä¸åŒ…å«æºç 

```bash
# è¿›å…¥å®¹å™¨æŸ¥çœ‹
docker run -it edge-system:latest sh

# åªèƒ½çœ‹åˆ°äºŒè¿›åˆ¶æ–‡ä»¶å’Œé…ç½®
/app $ ls
edge                # äºŒè¿›åˆ¶æ–‡ä»¶ï¼ˆæ— æ³•åç¼–è¯‘å›æºç ï¼‰
configs/            # é…ç½®æ–‡ä»¶
auth_verifying.key  # å¯†é’¥æ–‡ä»¶
```

### åç¼–è¯‘ä¿æŠ¤

Go äºŒè¿›åˆ¶æ–‡ä»¶è™½ç„¶å¯ä»¥åç¼–è¯‘ï¼Œä½†ï¼š
- å˜é‡åå…¨éƒ¨ä¸¢å¤±ï¼ˆå˜æˆ var1ã€var2ï¼‰
- æ³¨é‡Šå…¨éƒ¨ä¸¢å¤±
- ä»£ç ç»“æ„æ··ä¹±
- æ— æ³•è¿˜åŸåŸå§‹æºç 

### é¢å¤–ä¿æŠ¤ï¼ˆå¯é€‰ï¼‰

```bash
# ç¼–è¯‘æ—¶å»é™¤è°ƒè¯•ä¿¡æ¯å’Œç¬¦å·è¡¨
go build -ldflags="-s -w" -o edge cmd/edge/main.go

# -s: å»é™¤ç¬¦å·è¡¨
# -w: å»é™¤ DWARF è°ƒè¯•ä¿¡æ¯
```

---

## ğŸ’¡ å¸¸ç”¨å‘½ä»¤

### å®¹å™¨ç®¡ç†

```bash
# å¯åŠ¨
docker-compose up -d

# åœæ­¢
docker-compose down

# é‡å¯
docker-compose restart

# æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f

# æŸ¥çœ‹çŠ¶æ€
docker-compose ps
```

### é•œåƒç®¡ç†

```bash
# æŸ¥çœ‹é•œåƒ
docker images | grep edge-system

# åˆ é™¤é•œåƒ
docker rmi edge-system:latest

# å¯¼å‡ºé•œåƒ
docker save -o edge.tar edge-system:latest

# å¯¼å…¥é•œåƒ
docker load -i edge.tar
```

### è°ƒè¯•

```bash
# è¿›å…¥å®¹å™¨
docker exec -it edge-system sh

# æŸ¥çœ‹å®¹å™¨å†…æ—¥å¿—
docker exec edge-system cat /app/logs/edge.log

# æŸ¥çœ‹å®¹å™¨èµ„æºä½¿ç”¨
docker stats edge-system
```

---

## ğŸ“ å¯¹æ¯”ï¼šæºç éƒ¨ç½² vs å®¹å™¨åŒ–éƒ¨ç½²

| å¯¹æ¯”é¡¹ | æºç éƒ¨ç½² | å®¹å™¨åŒ–éƒ¨ç½²ï¼ˆæ— æºç ï¼‰ |
|--------|---------|-------------------|
| **æºç æ³„éœ²é£é™©** | âŒ é«˜ï¼ˆæºç åœ¨æœåŠ¡å™¨ï¼‰ | âœ… æ— ï¼ˆåªæœ‰äºŒè¿›åˆ¶ï¼‰ |
| **éƒ¨ç½²å¤æ‚åº¦** | âŒ å¤æ‚ï¼ˆéœ€å®‰è£… Goï¼‰ | âœ… ç®€å•ï¼ˆåªéœ€ Dockerï¼‰ |
| **ç¯å¢ƒä¾èµ–** | âŒ éœ€è¦ Go 1.24+ | âœ… åªéœ€ Docker |
| **è¿ç§»éš¾åº¦** | âŒ éš¾ï¼ˆéœ€é‡æ–°ç¼–è¯‘ï¼‰ | âœ… æ˜“ï¼ˆå¯¼å‡ºé•œåƒï¼‰ |
| **ç‰ˆæœ¬ç®¡ç†** | âŒ ä¾èµ– Git | âœ… é•œåƒ tag |
| **äº¤ä»˜ç‰©** | æºä»£ç  + æ–‡æ¡£ | é•œåƒ tar + é…ç½® |

---

## ğŸ“Š å®é™…æ¡ˆä¾‹

### åœºæ™¯ï¼šäº¤ä»˜ç»™å®¢æˆ·

**å®¢æˆ·éœ€æ±‚**ï¼š
- ä¸å¸Œæœ›çœ‹åˆ°æºä»£ç 
- å¸Œæœ›éƒ¨ç½²ç®€å•
- éœ€è¦åœ¨å¤šå°æœºå™¨éƒ¨ç½²

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. ä½¿ç”¨ `build.sh` æ„å»º Docker é•œåƒ
2. å¯¼å‡ºé•œåƒï¼š`edge-system.tar`ï¼ˆçº¦ 60MBï¼‰
3. æ‰“åŒ…é…ç½®æ–‡ä»¶
4. æä¾›ä¸€é”®éƒ¨ç½²è„šæœ¬

**äº¤ä»˜ç‰©**ï¼š
```
edge-deploy-v1.0.0/
â”œâ”€â”€ edge-system.tar
â”œâ”€â”€ docker-compose.yml
â”œâ”€â”€ configs/
â”œâ”€â”€ auth_verifying.key
â””â”€â”€ README.md
```

**å®¢æˆ·éƒ¨ç½²**ï¼ˆåªéœ€ 3 æ­¥ï¼‰ï¼š
```bash
docker load -i edge-system.tar
mkdir -p data logs
docker-compose up -d
```

**å®Œå…¨çœ‹ä¸åˆ°æºç ï¼** âœ…

---

## â“ å¸¸è§é—®é¢˜

### Q: Docker é•œåƒèƒ½è¢«åç¼–è¯‘å‡ºæºç å—ï¼Ÿ

A: **ä¸èƒ½**ã€‚é•œåƒä¸­åªæœ‰ç¼–è¯‘åçš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œæ— æ³•è¿˜åŸå‡ºåŸå§‹ Go æºä»£ç ã€‚

### Q: ä¸ºä»€ä¹ˆ Go ä¸éœ€è¦æºç éƒ¨ç½²ï¼Ÿ

A: Go ç¼–è¯‘åæ˜¯é™æ€é“¾æ¥çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼ŒåŒ…å«äº†æ‰€æœ‰ä¾èµ–ï¼Œå¯ä»¥ç›´æ¥è¿è¡Œã€‚

### Q: éœ€è¦åœ¨å®¢æˆ·æœºå™¨ä¸Šå®‰è£… Go å—ï¼Ÿ

A: **ä¸éœ€è¦**ã€‚åªéœ€è¦ Docker å³å¯ã€‚

### Q: å¦‚ä½•æ›´æ–°ç‰ˆæœ¬ï¼Ÿ

A: é‡æ–°æ„å»ºé•œåƒï¼Œå¯¼å‡ºæ–°ç‰ˆæœ¬çš„ tar æ–‡ä»¶ï¼Œå®¢æˆ·ç«¯é‡æ–°å¯¼å…¥å³å¯ã€‚

### Q: æ€§èƒ½ä¼šå—å½±å“å—ï¼Ÿ

A: **ä¸ä¼š**ã€‚å®¹å™¨åŒ–è¿è¡Œæ€§èƒ½å‡ ä¹ä¸åŸç”Ÿç›¸åŒï¼ˆ<5% æŸè€—ï¼‰ã€‚

---

## ğŸ“š è¯¦ç»†æ–‡æ¡£

- **å®Œæ•´æ–‡æ¡£**ï¼š`deployments/docker/README.md`
- **Dockerfile**ï¼š`deployments/docker/Dockerfile.production`
- **æ„å»ºè„šæœ¬**ï¼š`deployments/docker/build.sh`
- **å¯åŠ¨è„šæœ¬**ï¼š`deployments/docker/entrypoint.sh`

---

**æ€»ç»“**ï¼šGo ç¨‹åºå®¹å™¨åŒ–éƒ¨ç½²å®Œå…¨ä¸éœ€è¦æºç ï¼Œæ—¢ä¿æŠ¤äº†çŸ¥è¯†äº§æƒï¼Œåˆç®€åŒ–äº†éƒ¨ç½²æµç¨‹ï¼ğŸ‰
